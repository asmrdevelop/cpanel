#!/usr/local/cpanel/3rdparty/bin/perl

# cpanel - bin/cpses_pam_ctl                       Copyright 2022 cPanel, L.L.C.
#                                                           All rights reserved.
# copyright@cpanel.net                                         http://cpanel.net
# This code is subject to the cPanel license. Unauthorized copying is prohibited

package bin::cpses_pam_ctl;

use strict;
use warnings;

use Cpanel::FileUtils::Write ();
use Cpanel::Logger           ();

### This version number should match the values in /u/l/c/bin/cpsessetup
### and the pam_cpses RPM.
my $version = '1.1';

my @cpses_services = ('postgresql');    # once we get the perconia pam plugin:'mysql';

if ( !caller() ) {
    exit( __PACKAGE__->script(@ARGV) );
}

sub script {
    my ( $self, @args ) = @_;

    my $logger = Cpanel::Logger->new();

    if ( !@args ) {
        print "$0: usage [--enable|--disable]\n";
        return 1;

    }
    elsif ( $args[0] eq '--enable' ) {
        activate_pam();
    }
    elsif ( $args[0] eq '--disable' ) {
        deactivate_pam();
    }
    else {
        print "$0: usage [--enable|--disable]\n";
        return 1;
    }

    return 0;
}

sub deactivate_pam {
    foreach my $service (@cpses_services) {
        unlink("/etc/pam.d/$service\_cpses");
    }
    return;
}

sub activate_pam {
    my $pam_file_contents = <<EOM;
#%PAM-1.0
auth    required pam_cpses.so
account required pam_cpses.so
EOM

    foreach my $service (@cpses_services) {
        Cpanel::FileUtils::Write::overwrite_no_exceptions(
            "/etc/pam.d/$service\_cpses",
            $pam_file_contents, 0644
        );
    }

    return;
}
