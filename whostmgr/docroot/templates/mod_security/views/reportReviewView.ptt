<div class="section-heading">
    <h2 ng-bind-html="getTitleText()">[% locale.maketext('Report a [asis,ModSecurity] Rule') %]</h2>
    <span>[% locale.maketext('Review the information below before you submit your report.') %]</span>
</div>

<div class="section-body report-rule-body">
    <form class="layout-medium" novalidate>
        <div class="form-group" id="report-rule-form-data">
            <uib-tabset>
                <uib-tab select="changeToTab('hitList')">
                    <uib-tab-heading>[% locale.maketext('Associated Hits') %]</uib-tab-heading>
                    <span class="info-block tab-pane-header">[% locale.maketext('The list below contains the associated hits to send with the report. If you see multiple hits, exclude any unrelated hits from the report to help the vendor identify the problem.') %]</span>

                    <span ng-show="view.loading.init">
                        <i class="glyph fas fa-sync animate-spin"></i>
                        <span>[% locale.maketext('Loading …') %]</span>
                    </span>
                    <span class="text-danger" ng-hide="report.hits || view.loading.init">
                        [% locale.maketext('The system could not load the data.') %]
                    </span>
                    <table ng-show="report.hits && !view.loading.init" class="table" ng-repeat="hit in report.hits">
                        <thead>
                            <tr>
                                <th class="col-sm-1 text-center">[% locale.maketext('Included') %]</th>
                                <th class="col-sm-11">[% locale.maketext('Hit Data') %]</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="hit in report.hits">
                                <td class="text-center include-exclude-col">
                                    <button class="btn" ng-click="toggleIncludeExclude(hit)" ng-class="{ 'btn-success' : hit.included }">
                                        <span class="fas fa-check" ng-show="hit.included"></span>
                                        <span class="fas fa-times" ng-hide="hit.included"></span>
                                    </button>
                                </td>
                                <td>
                                    <div class="collapsed-hit-data" ng-hide="isExpanded(hit)">
                                        <div>
                                            <span>
                                                <label>[% locale.maketext('Source IP:') %]</label> {{ hit.ip }}
                                            </span>
                                            <span>
                                                <label>[% locale.maketext('Timestamp:') %]</label> {{ hit.timestamp }}
                                            </span>
                                        </div>
                                        <div>
                                            <span>
                                                <label>[% locale.maketext('Request:') %]</label> {{ hit.http_status }} {{ hit.http_method }} {{ hit.host }}{{ hit.path }}
                                            </span>
                                        </div>
                                        <div>
                                            <span>
                                                <label>[% locale.maketext('Action Description:') %]</label> {{ hit.action_desc }}
                                            </span>
                                        </div>
                                        <div>
                                            <span>
                                                <label>[% locale.maketext('Justification:') %]</label> {{ hit.justification }}
                                            </span>
                                        </div>
                                        <div>
                                            <button class="btn btn-default btn-xs" ng-click="toggleExpandCollapse(hit)">
                                                [% locale.maketext('See all data') %] <span class="glyphicon glyphicon-chevron-down">
                                            </button>
                                        </div>
                                    </div>
                                    <table class="table table-striped table-condensed expanded-hit-data" ng-show="isExpanded(hit)">
                                        <tr class="hit-field" ng-repeat="(key, val) in hit | onlyTrueHitFields">
                                            <td class="col-sm-2">{{ key }}</td>
                                            <td class="col-sm-10">{{ val }}</td>
                                        </tr>
                                    </table>
                                    <button class="btn btn-default btn-xs" ng-show="isExpanded(hit)" ng-click="toggleExpandCollapse(hit)">
                                        [% locale.maketext('See less data') %] <span class="glyphicon glyphicon-chevron-up">
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </uib-tab>

                <uib-tab select="changeToTab('ruleText')">
                    <uib-tab-heading>[% locale.maketext('Rule Text') %]</uib-tab-heading>
                    <span class="info-block tab-pane-header">[% locale.maketext('The report contains the complete text of the rule.') %]</span>

                    <span ng-show="view.loading.init">
                        <i class="glyph fas fa-sync animate-spin"></i>
                        <span>[% locale.maketext('Loading …') %]</span>
                    </span>
                    <span class="text-danger" ng-hide="report.rule || view.loading.init">
                            [% locale.maketext('The system could not load the data.') %]
                        </span>
                    <pre ng-show="report.rule && !view.loading.init" ng-bind-html="report.rule.rule"></pre>
                </uib-tab>

                <uib-tab select="changeToTab('rawReport')" active="view.rawReportActive" disabled="view.form.$invalid || view.loading.init">
                    <uib-tab-heading>
                        <span class='fas fa-exclamation-triangle fa-lg' ng-show="rawTabIsStale()" title="[% locale.maketext('A new version of the report is available.') %]"></span>
                        [% locale.maketext('Raw Report Data') %]
                    </uib-tab-heading>
                    <span class="info-block tab-pane-header">[% locale.maketext('The report contains the following raw [asis,JSON]:') %]</span>

                    <span ng-show="view.loading.report">
                        <i class="glyph fas fa-sync animate-spin"></i>
                        <span>[% locale.maketext('Loading …') %]</span>
                    </span>
                    <span class="text-danger" ng-hide="report.json || view.loading.report">
                        [% locale.maketext('The system could not load the data.') %]
                    </span>
                    <pre ng-show="report.json && !view.loading.report" ng-bind-html="report.json"></pre>
                </uib-tab>
            </uib-tabset>
        </div>

        <div class="form-group">
            <button type="submit" class="btn btn-primary" cp-action="submitReport()" ng-disabled="view.form.$invalid || report.invalid || view.loading.init || view.submitting">
                [% locale.maketext('Submit') %]
            </button>
            <button type="button" class="btn btn-default" ng-click="changeStep('input')">
                [% locale.maketext('Back') %]
            </button>
            <button type="button" class="btn btn-link" ng-click="cancelSubmission()">
                [% locale.maketext('Cancel Submission') %]
            </button>
        </div>

    </form>

</div>
