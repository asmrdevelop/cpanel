define("app/services/backup_API",["angular","cjt/util/locale","cjt/io/uapi-request","cjt/io/api","cjt/io/whm-v1-request","cjt/io/whm-v1","cjt/services/APIService"],(function(e,t,r,n,a,o){"use strict";var i;try{i=e.module("whm.fileAndDirectoryRestore")}catch(t){i=e.module("whm.fileAndDirectoryRestore",[])}i.factory("backupAPIService",["APIService",function(r){var n={compressed:t.maketext("Compressed"),uncompressed:t.maketext("Uncompressed"),incremental:t.maketext("Incremental")};function o(e){var r=e.data,a=[];return r.forEach((function(e){if(e.mtime=t.local_datetime(parseInt(e.mtime,10),"datetime_format_short"),!n.hasOwnProperty(e.backupType))throw"DEVELOPER ERROR: Invalid backup type";e.backupType=n[e.backupType],a.push(e)})),a}function i(e){return"/"+(e=e.data[0]).partition+"/"+e.user+"/"}var c=function(){};return c.prototype=new r,e.extend(c.prototype,{listDirectoryContents:function(e,t,r,n){var o=new a.Class;return o.initialize("","cpanel"),o.addArgument("cpanel_jsonapi_user",t),o.addArgument("cpanel_jsonapi_module","Restore"),o.addArgument("cpanel_jsonapi_func","directory_listing"),o.addArgument("cpanel_jsonapi_apiversion","3"),o.addArgument("path",e),o.addArgument("api.paginate",1),o.addArgument("api.paginate_start",r),o.addArgument("api.paginate_size",n),this.deferred(o,{transformAPISuccess:function(e){return e},transformAPIFailure:function(e){return e.error}}).promise},getUserHomeDirectory:function(e){var t=new a.Class;return t.initialize("","accountsummary"),t.addArgument("user",e),this.deferred(t,{transformAPISuccess:i}).promise},listUsers:function(e){var t=new a.Class;return"root"!==e?(t.initialize("","cpanel"),t.addArgument("cpanel_jsonapi_user",e),t.addArgument("cpanel_jsonapi_module","Restore"),t.addArgument("cpanel_jsonapi_func","get_users"),t.addArgument("cpanel_jsonapi_apiversion","3"),this.deferred(t,{transformAPISuccess:function(e){return null!==e.data?e.data.map((function(e){return{user:e}})):[]},transformAPIFailure:function(e){return e.error}}).promise):(t.initialize("","get_users_and_domains_with_backup_metadata"),this.deferred(t,{transformAPISuccess:function(e){return null!==e.data?Object.keys(e.data).map((function(t){return{user:t,domain:e.data[t]}})):[]},transformAPIFailure:function(e){return e.error}}).promise)},listBackups:function(e,t,r){var n=new a.Class;return n.initialize("","cpanel"),n.addArgument("cpanel_jsonapi_user",t),n.addArgument("cpanel_jsonapi_module","Restore"),n.addArgument("cpanel_jsonapi_func","query_file_info"),n.addArgument("cpanel_jsonapi_apiversion","3"),n.addArgument("path",e),n.addArgument("exists",r),this.deferred(n,{transformAPISuccess:o,transformAPIFailure:function(e){return e.error}}).promise},restoreBackup:function(e,t,r){var n=new a.Class;return n.initialize("","cpanel"),n.addArgument("cpanel_jsonapi_user",r),n.addArgument("cpanel_jsonapi_module","Restore"),n.addArgument("cpanel_jsonapi_func","restore_file"),n.addArgument("cpanel_jsonapi_apiversion","3"),n.addArgument("backupID",t),n.addArgument("path",e),n.addArgument("overwrite",1),this.deferred(n,{transformAPISuccess:function(e){return e.data},transformAPIFailure:function(e){return e.error}}).promise}}),new c}])})),define("app/views/backup_restore",["angular","lodash","cjt/util/table","cjt/util/locale","cjt/util/parse","app/services/backup_API","cjt/services/alertService","cjt/directives/alertList","cjt/directives/alert","cjt/services/cpanel/componentSettingSaverService"],(function(e,t,r,n,a){"use strict";return e.module("whm.fileAndDirectoryRestore").controller("listController",["$scope","$filter","$anchorScroll","backupAPIService","componentSettingSaverService","alertService",function(e,o,i,c,s,u){var d=new r;d.setSort("name","asc");var p=new r;function l(t,r){return s.get(t).then((function(n){n?(e.directoryContentsMeta.pageSize=n.pageSize,m(e.currentDirectory,r.user,e.directoryContentsMeta.start,e.directoryContentsMeta.pageSize)):function(e,t){s.register(e).then((function(r){g(e,t)})).catch((function(e){u.add({type:"danger",message:e,group:"whm-restoration",closeable:!0})}))}(t,r)})).catch((function(e){u.add({type:"danger",message:e,group:"whm-restoration",closeable:!0})}))}function f(t,r){d.load(t),function(t){for(var r=[],n=1;n<=t.total_pages;)n.toString(),r.push(n),parseInt(n,10),n++;e.goToPages=r}(r),function(t){e.directoryContentsMeta.pageNumber=1,d.update(),e.directoryContentsMeta.maxPages=parseInt(t.total_pages,10),e.directoryContentsMeta.totalItems=parseInt(t.total_records,10),e.directoryContentsMeta.start=parseInt(t.current_record,10),e.directoryContentsMeta.pageNumber=t.current_page,e.directoryContentsMeta.start+e.directoryContentsMeta.pageSize>e.directoryContentsMeta.totalItems?e.directoryContentsMeta.limit=e.directoryContentsMeta.totalItems:e.directoryContentsMeta.limit=e.directoryContentsMeta.start+e.directoryContentsMeta.pageSize-1,e.directoryContents=d.getList(),e.directoryContentsPaginationMessage=d.paginationMessage()}(r)}function m(t,r,n,a){return d.items=[],d.filteredList=[],d.last_id=0,c.listDirectoryContents(t,r,n,a).then((function(t){f(function(t){var r=[];return t.forEach((function(t){t.backupPath&&t.parentDir||("/"===e.currentDirectory?(t.backupPath="/"+t.name,t.parentDir="/"):(t.backupPath=e.currentDirectory+t.name,t.parentDir=e.currentDirectory)),r.push(t)})),e.parentDirectory=e.currentDirectory,r}(t.data),t.meta.paginate)})).catch((function(t){e.noMetadataMessage=t})).finally((function(){e.accountUser=r,e.inCpanel=!0,e.actions.loadingUI=!1,e.actions.loadingData=!1,0===e.directoryContents.length?e.emptyDirectory=!0:e.emptyDirectory=!1}))}function g(t,r){return s.set(t,{pageSize:e.directoryContentsMeta.pageSize}).then((function(t){var n;n=r?r.user:e.accountUser,e.directoryContentsMeta.start=h(e.directoryContentsMeta),m(e.currentDirectory,n,e.directoryContentsMeta.start,e.directoryContentsMeta.pageSize)})).catch((function(e){u.add({type:"danger",message:e,group:"backup-restortion",closeable:!0})}))}function y(t,r){return c.listBackups(t,e.accountUser,r).then((function(t){r&&(e.doesContentExist=a.parsePerlBoolean(t[0].exists)),i("backupsPanel"),e.isContentTypeDirectory="dir"===t[0].type,e.isBackupSelected=!0,p.load(t),p.update(),e.backupsMeta=p.getMetadata(),e.backupList=p.getList(),e.backupsPaginationMessage=p.paginationMessage()})).catch((function(t){e.getBackupsError=t})).finally((function(){e.actions.loadingBackups=!1}))}function h(e){return(e.pageNumber-1)*e.pageSize+1}function _(t){var r=t.split("/");e.breadCrumb=r.slice(1,r.length-1)}p.setSort("backupDate,backupType,lastModifiedTime,fileSize","desc"),e.scrollToBackupList=function(){i("backupsPanel")},e.sortDirectoryContentsTable=function(){var t=e.directoryContentsMeta.totalItems;if(e.directoryContentsMeta.pageNumber>=2){var r=e.directoryContentsMeta.pageNumber;d.meta.pageNumber=1,d.update(),d.meta.pageNumber=r}else d.update();e.directoryContentsMeta.totalItems=t,e.directoryContents=d.getList()},e.navigateBreadcrumb=function(t){e.actions.loadingData=!0;for(var r="/",n=0,a=e.breadCrumb.length;n<a;n++){if(t===e.breadCrumb[n]){r=r+e.breadCrumb[n]+"/";break}r=r+e.breadCrumb[n]+"/"}e.currentDirectory=r;m(e.currentDirectory,e.accountUser,1,e.directoryContentsMeta.pageSize),_(e.currentDirectory)},e.goToDirectory=function(t){var r;if(e.actions.loadingData=!0,"/"===t&&(e.breadcrumb=""),e.clearBackupList(),e.currentDirectory===t)r=h(e.directoryContentsMeta);else{e.currentDirectory=t;var n=e.currentDirectory.length;"/"!==e.currentDirectory.charAt(n-1)&&(e.currentDirectory=e.currentDirectory+"/"),r=1}m(e.currentDirectory,e.accountUser,r,e.directoryContentsMeta.pageSize),_(e.currentDirectory)},e.setDirectoryContentsPage=function(t,r){e.actions.loadingData=!0,t?g("whm_file_and_dir_restoration"):(e.directoryContentsMeta.start=h(e.directoryContentsMeta),m(e.currentDirectory,e.accountUser,e.directoryContentsMeta.start,e.directoryContentsMeta.pageSize,e.directoryContentsMeta.pageNumber))},e.listBackups=function(t,r){return e.actions.loadingBackups=!0,e.clearBackupList(),e.selectedContent=t,e.doesContentExist=r,y(t,0)},e.clearBackupList=function(){e.toggleRestoreConfirmation(),e.getBackupsError="",e.isBackupSelected=!1,e.selectedContent=""},e.toggleRestoreConfirmation=function(t){t?(e.confirmSelected=t.backupDate,e.isConfirmingRestoration=!0):(e.confirmSelected="",e.isConfirmingRestoration=!1)},e.restoreSelectedBackup=function(r){return function(r){return e.actions.restoring=!0,c.restoreBackup(r.path,r.backupID,e.accountUser).then((function(a){u.add({type:"success",message:n.maketext("The system successfully restored the “[_1]” backup file from the date “[_2]”.",t.escape(r.path),t.escape(r.backupDate)),autoClose:1e4,group:"whm-restoration"}),e.clearBackupList(),e.goToDirectory(e.currentDirectory)})).catch((function(t){u.add({type:"danger",message:t,closeable:!0,group:"whm-restoration"}),e.toggleRestoreConfirmation()})).finally((function(){e.actions.restoring=!1}))}(r)},e.getBackupsPanelClass=function(e){var t="panel panel-default";return e&&(t+=" restorationPanel"),t},e.getDirContentsPanelClass=function(e){var t="panel panel-default";return e&&(t+=" restorationPanel"),t},e.getUserHomeDir=function(t){return c.getUserHomeDirectory(t.user).then((function(r){e.userHomeDirDisplay=r,e.parseAccountRequest(t)})).catch((function(e){u.add({type:"danger",message:e,closeable:!0,group:"whm-restoration"})}))},e.parseAccountRequest=function(e){return l("whm_file_and_dir_restoration",e)},e.checkForEmptyInput=function(t){e.isPathInputEmpty=""===t},e.findByPathInput=function(t){return t=function(e){return 0!==e.indexOf("/")&&(e="/"+e),e}(t),e.clearBackupList(),e.selectedContent=t,y(t,1)},e.getAccounts=function(){return e.isPathInputEmpty=!0,e.clearBackupList(),e.breadCrumb=[],e.currentDirectory="/",c.listUsers(window.loggedInUser).then((function(t){e.accounts=e.orderAccounts(t)||[],e.currentDirectoryContent=[],e.backupList=[]})).catch((function(e){u.add({type:"danger",message:n.maketext("File restoration failure: [_1]",e),closeable:!0,group:"whm-restoration"})})).finally((function(){e.inCpanel=!1,e.initialDataLoaded=!0}))},e.orderAccounts=function(e){return o("orderBy")(e,"user")},e.init=function(){e.inCpanel=!1,e.isPathInputEmpty=!0,e.currentDirectory="/",e.homeDir="/",e.navigateMethod="input",e.dirContentsPanelOpen=!0,e.backupsPanelOpen=!0,e.directoryContentsMeta=d.getMetadata(),e.backupsMeta=p.getMetadata(),e.doesContentExistInfo=n.maketext("When you restore a backup, the system will overwrite existing files and restore deleted files."),e.findByPathInfo=n.maketext("Enter the exact path to the file or directory that you wish to restore."),e.initialDataLoaded=!1,e.getAccounts(),e.actions={loadingData:!1}},e.init()}])})),define("app/filters/file_size_filter",["angular","cjt/util/locale"],(function(e,t){"use strict";var r;try{r=e.module("whm.fileAndDirectoryRestore")}catch(t){r=e.module("whm.fileAndDirectoryRestore",[])}r.filter("convertedSize",(function(){return function(e){return"number"!=typeof e||isNaN(e)?t.maketext("N/A"):t.format_bytes(e)}}))})),define("app/index",["angular","cjt/core","cjt/modules","ngRoute","uiBootstrap"],(function(e,t){"use strict";return function(){return e.module("whm.fileAndDirectoryRestore",["cjt2.config.whm.configProvider","ngRoute","ui.bootstrap","cjt2.whm"]),require(["cjt/bootstrap","cjt/views/applicationController","app/views/backup_restore","app/filters/file_size_filter"],(function(t){e.module("whm.fileAndDirectoryRestore").config(["$routeProvider",function(e){e.when("/backup_restore",{controller:"listController",templateUrl:"file_and_directory_restoration/views/backup_restore.ptt"}),e.otherwise({redirectTo:"/backup_restore"})}]),t(document,"whm.fileAndDirectoryRestore")}))}}));