[%
    USE Whostmgr;
    USE JSON;

    SET PAGE_BASE = '/scripts/userlist/';
    SET PAGE_PATH = data.page_path;
    SET PAGE_NAME = data.page_title;
    SET APP_KEY = data.app_key;

    SET user_not_required = data.user_not_required;

    WRAPPER 'master_templates/master.tmpl'
        breadcrumburl = PAGE_BASE,
        base =  PAGE_PATH,
        header = PAGE_NAME,
        theme='bootstrap',
        app_key= APP_KEY,
        CJT2_EXCLUSIVE = 1;

    PROCESS 'master_templates/cjt2_header_include.tt';

%]
<div id="content" autofocus="true">
    [% IF Whostmgr.hasroot() AND APP_KEY == 'quota_modification' %]
    <div class="alert alert-warning quota_sensitive" style="display:none;">
        <span class="glyphicon glyphicon-exclamation-sign"></span>
        [% IF Whostmgr.template_vars.needs_reboot.quota %]
        <div class="alert-message">[% locale.maketext("Quotas are currently disabled. Quotas defined in packages will not function until you [output,url,_1,reboot,target,_blank].","$cp_security_token/scripts/graceful_reboot_landing?suggest=1") %]</div>
        [% ELSE %]
        <div class="alert-message">[% locale.maketext("Quotas are currently disabled. Quotas defined in packages will not function until you [output,url,_1,enable,target,_blank] them.", "$cp_security_token/scripts/dialog?dialog=quotas") %]</div>
        [% END %]
    </div>
    [% END %]


    <div id="userListWidget"
         ng-controller="UserListController as base"
         class="ng-cloak form-area"
         ng-cloak >

        <form name="userSelectionForm" method="post" class="layout-medium" action="[% data.form_tag_action_param %]" ng-submit="can_submit()" novalidate>

            [% IF data.description_text -%]
                <p>
                    [% data.description_text %]
                </p>
            [% END -%]

            <input
                type='hidden'
                name="user"
                [% IF !user_not_required %]
                required
                [% END %]
                value="{{selectedDomain.user}}" />

            [%# second page interfaces rely on domain equalling the username instead
                so I’m keeping this broken like the old interface to not break others -%]
            <input
                type='hidden'
                name="domain"
                required
                value="{{selectedDomain.user}}" />

            <!-- Some pages require additional custom form fields (add a dns / change password) -->

            [% IF data.form_widget_top -%]
                <div class="form-widget form-widget-top">
                    [% widget_template = 'userlist/widgets/' _ data.form_widget_top _ '.ptt' %]
                    [% PROCESS $widget_template %]
                </div>
            [% END -%]

            [%# “user” input comes from the user-domain-list directive -%]

            <user-domain-list
                id="userDomainList"
                ng-hide="!domains.length && [% user_not_required %]"
                domains="domains"
                edit-locked-accounts="editLockedAccounts"
                selection-required="userRequired"
                ng-model="selectedDomain"
                ></user-domain-list>

            <div class="row">
                <div class="col-md-12">
                    <div class="form-group action-group">
                        [% IF data.userdomains.size() > 0 || user_not_required %]
                        <button type="submit" ng-disabled="!userSelectionForm.$valid" class="btn btn-primary" id="userDomainListSaveButton">[% data.button_text %]</button>
                        [% END %]
                        [% IF data.additional_actions %]
                            [% FOREACH action IN data.additional_actions %]
                                <a id="[% action.id %]" href="[% action.uri %]" class="btn btn-default">
                                    [% IF action.icon %]
                                        <span class="[% action.icon %]"></span>
                                    [% END %]
                                    [% action.label %]
                                </a>
                            [% END %]
                        [% END %]
                    </div>
                </div>
            </div>
        </form>
        <div growl></div>
    </div>


</div>

<script type="text/javascript">
    var PAGE = PAGE || {};
    PAGE.domains = [% JSON.stringify(data.userdomains) %];
    PAGE.childWorkloadAccounts = [% JSON.stringify(data.child_workload_accts) %];
    PAGE.userRequired = '[% !user_not_required %]';
</script>

<style type="text/css">
    .validation-container {
        margin-top:5px;
    }
</style>

[% END; %]
