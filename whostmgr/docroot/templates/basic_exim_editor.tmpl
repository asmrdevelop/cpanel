[% USE CPScalar -%]
[% USE JSON -%]
[% USE Encoder -%]
[% USE Whostmgr -%]
[% WRAPPER 'master_templates/master.tmpl' theme="yui"
    inside_frame_or_tab_or_popup = in_tab
    skipheader = in_tab
    stylesheets = [
    Whostmgr.find_file_url('css/tweaksettings_optimized.css'),
    Whostmgr.find_file_url('yui/tabview/assets/skins/sam/tabview.css'),
    Whostmgr.find_file_url('css/_gentweakpage.css')
    ]
    scripts = [
    Whostmgr.find_file_url('/js/exim_tabs_optimized.js')
    Whostmgr.find_file_url('/js/popupbox.js')
    Whostmgr.find_file_url('/js/statusbox.js')
    Whostmgr.find_file_url('js/yahoo_form_optimized.js')
    Whostmgr.find_file_url('yui/tabview/tabview-min.js')
    ]
    extrastyle = '
/* Tab Style */
#pageContainer {
    margin: 0;
    padding: 0;
}

#contentContainer{
    max-width: inherit !important;
}

/* End Tab Style */

.confeditbox {
    overflow: hidden;
}

.brickliststart li {
    list-style: none;
}

.brickcontainer {
    width: 100%;
}

#rbl_table {
    width: 100%;
}

#rbl_table th,
#rbl_table td {
    text-align: center;
}

tr.delete_rbl td {
    font-style: italic;
    color: graytext;
}

.CONFIG_autocompleter {
    width: 280px;
}

.CONFIG_autocompleter input {
    width: 256px;
}

td.controls,
th.controls {
    width: 245px !important;
}

.yui-skin-sam .yui-ac-input {
    position: static;
    width: 20em;
    vertical-align: middle;
}

.yui-skin-sam .yui-ac-container {
    width: 20em;
    left: 0px;
}

.yui-ac .yui-button {
    vertical-align: middle;
}

.yui-ac .yui-button button {
    background: url(/yui-gen/autocomplete/assets/img/ac-arrow-rt.png) center center no-repeat
}

.yui-ac .open .yui-button button {
    background: url(/yui-gen/autocomplete/assets/img/ac-arrow-dn.png) center center no-repeat
}

html[dir="rtl"] .sortable .cell,
html[dir="rtl"] .fixedtable .cell,
html[dir="rtl"] .datatable .cell {
    border-left: 1px solid #ccc;
}

html[dir="rtl"] .yui-panel .container-close {
    left: 4px;
    right: auto;
}

.button-group button:hover {
    border-width: 1px;
}
'
-%]
<div class="brickcontainer tweaksettings">
<div class="brickcontainer2">
<script type="text/javascript">
function handleClose() {
    this.hide();
}

var newdlg;
function rendernewdlg() {
    if (!newdlg) {
        newdlg = new YAHOO.widget.Panel(
            "newdlg",
            {
                width: "620px",
                fixedcenter: true,
                visible: false,
                draggable: false,
                close: true,
                constraintoviewport: true,
                buttons: [
                    {
                        text: "Close",
                        handler: handleClose,
                        isDefault: true
                    }
                ]
            }
        );

        newdlg.element.style.display = "none";
        newdlg.render();
    }
}

function vizacls() {
    // Instantiate the Dialog
    var eform = document.getElementById('eximopts');
    var formA = getFormData(eform);
    var uriA = [];
    for(var i in formA) {
        if (i == 'module' || i == 'viz') { continue; }
        if (formA[i] == true || formA[i] == false) {
            uriA.push(i + '=' + (formA[i] ? 1 : 0));
        } else {
            uriA.push(i + '=' + encodeURIComponent(formA[i]));
        }
    }
    var qs = uriA.join('&');
    newdlg.setBody('<iframe src="[% cp_security_token %]/cgi/mailflow.cgi?use_form=1&' + qs + '" style="height:400px;width:610px;margin:0:padding:0;"></iframe>');
    newdlg.element.style.display = "";
    newdlg.show();
}
YAHOO.util.Event.onAvailable('newdlg', rendernewdlg);

function notify_parent_submit() {
    if (parent && parent.notify_submit)  {
        parent.notify_submit('basic','Saving Basic Configuration...');
    }
}

</script>

[% WRAPPER '_brick.tmpl' bricktitle='Standard options' -%]
Note that a warning icon before an option indicates that it has not been previously set.
Please review all new options carefully before saving your changes.<br/><br/>
Options in <i>italics</i> are unavailable because of other options that are set.
[% END -%]
<br />
<br />

<form [% IF in_tab %]target="tabaction"[% END %] action="[% cp_security_token %]/scripts2/saveeximtweaks" method="post" name="exopt" id="eximopts" onSubmit="notify_parent_submit();">
<input type="hidden" name="in_tab" value="[% in_tab %]">
[%
SET extra_settings = {};
SET extra_texts = { 'RBLs' => {}, 'Filters' => {} };
FOREACH rbl = data.rbls;
    NEXT IF rbl.dist;
    SET rbl.name = Encoder.safe_html_encode_str(rbl.name);
    SET rbl.url = Encoder.safe_html_encode_str(rbl.url);

    SET ts_name = "acl_${rbl.name}_rbl";
    extra_settings.$ts_name = {
        'default'    => 0,
        'type'       => 'binary',
    };
    extra_texts.RBLs.$ts_name = {
        'label' => "Custom RBL: ${rbl.name}",
        'help'  => "Reject mail at SMTP time if the sender host is in the ${rbl.name} RBL"
        _ ( rbl.url
            ? ( " [<a href='${rbl.url}'>INFO</a>]<br />DNS list: "
                _ Encoder.safe_html_encode_str(rbl.dnslists.join(', ')) )
            : ''
        ),
    };
END;
FOREACH filter = data.filters;
    NEXT IF filter.dist;
    SET filter.name = Encoder.safe_html_encode_str(filter.name);

    SET ts_name = "filter_${filter.name}";
    extra_settings.$ts_name = {
        'default'    => 1,
        'type'       => 'binary',
    };
    extra_texts.Filters.$ts_name = {
        'label' => "Custom Filter: ${filter.name}",
        'help'  => "Enables Custom Filter: ${filter.name}"
    };
END;

PROCESS '_gentweakpage.tmpl'
    tweakmodule = 'Mail'
    tweakcfg = {
        'display_label'  => 1,
        'use_popupbox'   => 1,
        'extra_settings' => extra_settings,
        'extra_texts'    => extra_texts,
    }
    conf = data.eximopts
    nocontainers = 0
;
-%]

            <div id="newdlg">
            <div class="hd">Exim ACL Flowchart</div>
            <div class="bd">This is a Panel that was marked up in the document.</div>
            </div>

            <div style="margin: 0 auto;">
                <input class="btn-secondary" type="button" name="viz" value="Visualize ACLs" style="margin:0;" onClick="vizacls(); return false;">
                <input type="submit" class="btn-primary" value="Save">
            </div>
</form>
<br />
<br />
<!--

[% WRAPPER '_brick.tmpl' bricktitle='Advanced Editor' -%]
<blockquote>
    The Advanced Configuration Editor will allow you to modify the default configuration of Exim.
    Configuration changes made within this editor will be conserved across Exim updates and reinstallation.
    Changes to the default configuration can significantly impact Exim's performance and may prevent it from
    operating altogether. Use this editor with caution.
    <br />
    <br />
    <i>Note: Directly editing the Exim configuration file (usually located at /etc/exim.conf) will only work
    temporarily as an update to Exim will result in the changes being overwritten.</i>
    <br />
    <br />
</blockquote>
<blockquote>
    <div><b>To begin modifying the Exim configuration choose the Advanced Editor below.</b></div>
</blockquote>

<br />

<div>
    <form action="[% cp_security_token %]/scripts2/advanced_exim_editor" method="GET">
        <input type="submit" class="btn-primary" value="Advanced Editor">
    </form>
</div>
<br />
[% END #brick -%]
<br />
-->

[% END #wrapper -%]
