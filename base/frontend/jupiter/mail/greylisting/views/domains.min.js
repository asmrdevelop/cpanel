define(["angular","lodash","cjt/util/locale","uiBootstrap","cjt/decorators/paginationDecorator","cjt/directives/toggleSortDirective","cjt/directives/pageSizeDirective","cjt/directives/validationItemDirective","cjt/directives/spinnerDirective","cjt/directives/autoFocus","cjt/directives/alertList","cjt/services/alertService","cjt/filters/wrapFilter","cjt/filters/breakFilter","app/services/domainService"],(function(e,t,a){"use strict";var i=e.module("App"),l=function(e,t){for(var a=0,i=e.length;a<i;a++){var l=o(t,e[a].domain);l?(e[a].enabled=l.enabled,l.exception?e[a].exception=l.exception:delete e[a].exception):e[a].exception&&delete e[a].exception}},o=function(e,t){for(var a=0,i=e.length;a<i;a++)if(e[a].domain===t)return e[a]};return i.controller("domainListController",["$scope","$routeParams","$q","DomainService","spinnerAPI","alertService",function(t,o,n,s,r,c){t.allDomainsAreDisabled=function(){return t.totalDisabled===t.totalItems},t.allDomainsAreEnabled=function(){return t.totalEnabled===t.totalItems},t.hasNoDomains=function(){return 0===t.totalItems},t.clearFilter=function(){return t.meta.filterValue="",t.activeSearch=!1,t.filteredData=!1,t.selectedRow=-1,t.fetch()},t.startFilter=function(){t.activeSearch=!0,t.filteredData=!1,t.selectedRow=-1;var e=n.defer();e.promise.then((function(){t.selectPage(1)})).then((function(){t.filteredData=!0})),e.resolve()},t.toggleRow=function(e,a){e.preventDefault(),a===t.selectedRow?t.selectedRow=-1:t.selectedRow=a},t.selectPageSize=function(){t.selectPage(1)},t.selectPage=function(a){return t.selectedRow=-1,a&&e.isNumber(a)&&(t.meta.pageNumber=a),t.fetch()},t.sortList=function(e,a){t.selectedRow=-1,a||t.fetch()},t.triggerToggleSearch=function(e){27===e.keyCode&&t.toggleSearch(!0),13===e.keyCode&&t.toggleSearch()},t.toggleSearch=function(e){var a=t.meta.filterValue;a||!t.activeSearch&&!t.filteredData?e&&t.activeSearch?t.clearFilter():a&&t.startFilter():t.clearFilter()},t.fetch=function(){return r.start("loadingSpinner"),s.fetchList(t.meta).then((function(e){t.domainList=e.items,t.totalItems=e.totalItems,t.totalPages=e.totalPages,t.totalEnabled=e.totalEnabled,t.totalDisabled=e.totalDisabled,t.meta.start=(t.meta.pageNumber-1)*t.meta.pageSize+1,t.meta.limit=t.meta.pageNumber*t.meta.pageSize,t.meta.limit>t.totalItems&&(t.meta.limit=t.totalItems),0===t.meta.limit&&(t.meta.start=0)}),(function(e){c.add({type:"danger",message:e,closeable:!0,replace:!1,group:"greylisting"})})).then((function(){r.stop("loadingSpinner")}))},t.setDomain=function(e){return r.start("loadingSpinner"),e.enabled?s.enableDomains(e.domain).then((function(e){t.totalEnabled++,t.totalDisabled--,c.add({type:"success",message:a.maketext("Successfully enabled [asis,Greylisting] on “[output,class,_1,nobreak]”.",e.items[0].domain),closeable:!0,replace:!1,autoClose:1e4,group:"greylisting"})}),(function(e){c.add({type:"danger",message:e.error,closeable:!0,replace:!1,group:"greylisting"})})).then((function(){r.stop("loadingSpinner")})):s.disableDomains(e.domain).then((function(e){t.totalDisabled++,t.totalEnabled--,c.add({type:"success",message:a.maketext("Successfully disabled [asis,Greylisting] on “[output,class,_1,nobreak]”.",e.items[0].domain),closeable:!0,replace:!1,autoClose:1e4,group:"greylisting"})}),(function(e){c.add({type:"danger",message:e.error,closeable:!0,replace:!1,group:"greylisting"})})).then((function(){r.stop("loadingSpinner")}))},t.enableAllDomains=function(e){if(!t.allDomainsAreEnabled())return r.start("loadingSpinner"),s.enableAllDomains().then((function(e){l(t.domainList,e.items),t.totalItems=e.totalItems,t.totalPages=e.totalPages,t.totalEnabled=e.totalItems,t.totalDisabled=0,c.add({type:"success",message:a.maketext("Successfully enabled [asis,Greylisting] on all domains."),closeable:!0,replace:!1,autoClose:1e4,group:"greylisting"})}),(function(e){c.add({type:"danger",message:e.error,closeable:!0,replace:!1,group:"greylisting"})})).then((function(){r.stop("loadingSpinner")}))},t.disableAllDomains=function(e){if(!t.allDomainsAreDisabled())return r.start("loadingSpinner"),s.disableAllDomains().then((function(e){l(t.domainList,e.items),t.totalItems=e.totalItems,t.totalPages=e.totalPages,t.totalDisabled=e.totalItems,t.totalEnabled=0,c.add({type:"success",message:a.maketext("Successfully disabled [asis,Greylisting] on all domains."),closeable:!0,replace:!1,autoClose:1e4,group:"greylisting"})}),(function(e){c.add({type:"danger",message:e.error,closeable:!0,replace:!1,group:"greylisting"})})).finally((function(){r.stop("loadingSpinner")}))},t.hasDisabledDomains=function(){return t.totalDisabled>0};t.activeSearch=!1,t.filteredData=!1,t.totalEnabled=0,t.totalDisabled=0,t.selectedRow=-1,t.isEnabled=PAGE.enabled,t.hasFeature=PAGE.hasFeature,t.hasFeature&&(t.domainList=[],t.totalPages=0,t.totalItems=0,t.meta={filterBy:o.filterBy||"*",filterCompare:o.filterCompare||"contains",filterValue:o.filterValue||"",pageSize:o.pageSize||20,pageNumber:o.pageNumber||1,sortDirection:o.sortDirection||"asc",sortBy:o.sortBy||"domain",sortType:o.sortType,pageSizes:[20,50,100],start:0,limit:0}),t.$watch("meta.filterValue",(function(e,a){e!==a&&(t.activeSearch=!1)})),function(){if(i.firstLoad.domainList&&PAGE.domainList){i.firstLoad.domainList=!1;var e=s.prepareList(PAGE.domainList);t.meta.pageNumber=1,t.domainList=e.items,t.totalItems=e.totalItems,t.totalPages=e.totalPages,t.totalEnabled=PAGE.domainList.meta.cPGreyList.total_enabled,t.totalDisabled=PAGE.domainList.meta.cPGreyList.total_disabled,t.meta.start=(t.meta.pageNumber-1)*t.meta.pageSize+1,t.meta.limit=t.meta.pageNumber*t.meta.pageSize,t.meta.limit>t.totalItems&&(t.meta.limit=t.totalItems),0===t.meta.limit&&(t.meta.start=0)}else t.selectPage(1)}()}])}));