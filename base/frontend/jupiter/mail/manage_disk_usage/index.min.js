define(["angular","lodash","cjt/util/locale","cjt/io/uapi-request","cjt/io/batch-request","cjt/io/uapi","cjt/modules","cjt/directives/formWaiting","cjt/directives/searchDirective","cjt/directives/alertList","cjt/services/alertService","uiBootstrap","cjt/services/APICatcher","cjt/directives/toggleSortDirective","jquery-chosen","angular-chosen"],(function(e,t,a,s,i){"use strict";var n,c=CPANEL.PAGE,o=window.Disk_Usage_Meter,r=c.account;function u(e){var t=[(new s.Class).initialize("Mailboxes","get_mailbox_status_list",{account:e})];return o&&e===c.authuser&&t.push(n),t}n=r===c.cpuser?(new s.Class).initialize("Email","get_main_account_disk_usage_bytes"):(new s.Class).initialize("Email","list_pops_with_disk",{filter:[["email","eq",r]]});var l={"30mib":"larger 30M",seen:"seen",all:"all"};return function(){require(["cjt/bootstrap"],(function(n){e.module("App",[window.PAGE.CJT2_ANGULAR_MODULE_NAME,"cjt2.directives.search","ui.bootstrap","localytics.directives"]).controller("BaseController",["$scope","$location","$sce","APICatcher","alertService",function(e,n,p,m,_){var g;function h(t){g={};for(var s=0;s<t.length;s++)g[t[s].mailbox]=t[s],t[s].display_name=(""+t[s].mailbox).replace(/^INBOX\./,""),t[s].messages=parseInt(t[s].messages,10),t[s].vsize=parseInt(t[s].vsize,10),t[s].messages_numf=a.numf(t[s].messages),t[s].vsize_format_bytes=a.format_bytes(t[s].vsize);e.mailbox_status=t}h(CPANEL.PAGE.initial_mailbox_status);var d,v={};function f(e){if(h(e[0].data),e[1]){var t,a=e[1].data;t=r===c.cpuser?a:a[0]._diskused,o.set(t)}}v[r]={},d=n.search(),e.search_filter=d.q&&t.isString(d.q)?d.q:"";var b=c.pops.filter((function(e){return e!==c.cpuser}));b.length<c.pops.length&&b.push(c.cpuser);for(var x=[],w=0;w<b.length;w++)b[w]===r?r===c.cpuser?x.push("<option selected value='"+t.escape(r)+"'>("+a.maketext("System Account")+")</option>"):x.push("<option value='"+t.escape(b[w])+"' selected>"+t.escape(b[w])+"</option>"):b[w]===c.cpuser?x.push("<option value='"+t.escape(b[w])+"'>("+a.maketext("System Account")+")</option>"):x.push("<option value='"+t.escape(b[w])+"'>"+t.escape(b[w])+"</option>");t.assign(e,{LOCALE:a,mbmeta:v,show_account_selector:b.length>1,account_options_html:p.trustAsHtml(x.join("")),pops:b,account:r,mbsort:{sortBy:"vsize",sortDirection:"desc"},toggle_expunge:function(e){this._toggle_action("expunge",e)},_toggle_action:function(t,a){if(this.mbmeta[e.account][a]){if(this.mbmeta[e.account][a].action===t)return void(this.mbmeta[e.account][a].action=null)}else this.mbmeta[e.account][a]={expunge_preset:"1y"};this.mbmeta[e.account][a].action=t},reload:function(){this.mbmeta[e.account]||(this.mbmeta[e.account]={});var t=u(e.account),a=new i.Class(t);e.reloading=!0;var s=m.promise(a);return s.finally((function(){delete e.reloading})),s.then((function(e){f(e.data)}))},expunge:function(n){var c,o=this.mbmeta[e.account][n].expunge_preset;switch(o){case"1y":var r=new Date,p=new Date(r);p.setFullYear(r.getFullYear()-1),c="sentbefore "+Math.round((r-p)/864e5)+"days";break;case"custom":c=this.mbmeta[e.account][n].expunge_query;break;default:c=l[o]}if(!c)throw"Unknown preset: "+o;var h=(new s.Class).initialize("Mailboxes","expunge_messages_for_mailbox_guid",{account:e.account,mailbox_guid:g[n].guid,query:c}),d=u(e.account);d.unshift(h);var v=new i.Class(d),b=this;return m.promise(v).then((function(s){_.add({type:"success",message:a.maketext("The operation on “[_1]” succeeded.",t.escape(g[n].display_name)),closeable:!0,replace:!1,autoClose:1e4,group:"emailDiskUsage"}),b.mbmeta[e.account][n].action=null,f(s.data.slice(1))}))}})}]),n("#ng_content","App")}))}}));