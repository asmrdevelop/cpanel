define(["angular","cjt/util/locale","cjt/core","ngRoute","ngSanitize","cjt/modules","app/directives/tableShowingDirective","cjt/services/cpanel/componentSettingSaverService","app/services/domains","cjt/directives/toggleSortDirective","cjt/directives/searchDirective","cjt/directives/pageSizeDirective","cjt/filters/startFromFilter","cjt/decorators/paginationDecorator"],(function(e,t,i){"use strict";var r=e.module("cpanel.domains.itemLister.directive",["cpanel.domains.tableShowing.directive","ngRoute","ngSanitize","cjt2.filters.startFrom"]);r.value("PAGE",PAGE),r.directive("itemLister",["$window","$log","componentSettingSaverService","PAGE",function(r,n,a,s){var o="domainsItemLister",l="directives/itemLister.ptt";return{templateUrl:i.config.debug?i.buildFullPath("domains/directives/itemLister.ptt"):l,restrict:"EA",scope:{parentID:"@id",items:"=",headerItems:"=",configurationOptions:"="},transclude:!0,replace:!0,link:function(t,i,r,n){var a,s;function o(i){e.element(i).hasClass("lister-controls")?function(e){a.append(e)}(i):function(e){e.setAttribute("id",t.parentID+"_transcludePoint"),e.setAttribute("ng-if","filteredItems.length"),s.replaceWith(e)}(i)}setTimeout((function(){a=i.find("#"+t.parentID+"_transcludedControls"),s=i.find("#"+t.parentID+"_transcludePoint");var r=i.find("div.transcluded"),n=r.children();e.forEach(n,o),r.remove()}),2)},controller:["$routeParams","$scope","$filter","ITEM_LISTER_CONSTANTS","domains","alertService",function(i,l,c,d,u,f){l.redirectSelection=1,l.viewCallbacks=[],l.webserverRoleAvailable=s.hasWebServerRole;var m={filter:c("filter"),orderBy:c("orderBy"),startFrom:c("startFrom"),limitTo:c("limitTo")};function g(e){if(!l.loadingInitialState){var t={totalItems:l.totalItems,currentPage:l.currentPage,pageSize:l.pageSize,start:l.start,limit:l.limit,lastInteractedItem:e,filterValue:l.filterValue,sort:{sortDirection:l.sort.sortDirection,sortBy:l.sort.sortBy}};a.set(o,t)}}this.registerViewCallback=function(e){l.viewCallbacks.push(e),e(l.filteredItems)},this.getHeaderItems=function(){return l.headerItems},this.deregisterViewCallback=function(e){for(var t=l.viewCallbacks.length-1;t>=0;t--)l.viewCallbacks[t]===e&&l.viewCallbacks.splice(t,1)},l.fetch=function(){var t=[];return t=function(e){return""!==l.filterValue?m.filter(e,l.filterValue,!1):e}(l.items),l.totalItems=t.length,t=function(e){if(l.totalItems>_.min(l.pageSizes)){var t=(l.currentPage-1)*l.pageSize,i=l.pageSize;e=m.startFrom(e,t),e=m.limitTo(e,i),l.showPager=!0,l.start=t+1,l.limit=t+e.length}else l.showPager=!1,0===e.length?l.start=0:l.start=1,l.limit=e.length;return e}(t=function(e){return""!==l.sort.sortDirection&&""!==l.sort.sortBy?("batchSelect"===l.sort.sortBy&&(l.sort.sortBy="domain"),m.orderBy(e,l.sort.sortBy,"asc"!==l.sort.sortDirection)):e}(t)),l.filteredItems=t,g(),e.forEach(l.viewCallbacks,(function(e){e(l.filteredItems)})),l.$emit(d.ITEM_LISTER_UPDATED_EVENT,{meta:{filterValue:l.filterValue}}),t},l.focusSearch=function(){e.element(document).find("#"+l.parentID+"_search_input").focus(),r.scrollTop=0},l.configurationClicked=function(e){l.$emit(e)},l.$on(d.TABLE_ITEM_BUTTON_EVENT,(function(e,t){t.interactionID&&g(t.interactionID)})),l.$on(d.ITEM_SELECT_EVENT,(function(e,t){for(var i=!0,r=u.getCurrentDomains(),n=0;n<r.length;n++)if(!r[n].selected){i=!1;break}l.selectAll=i})),e.extend(l,{maxPages:5,totalItems:l.items.length,filteredItems:[],currentPage:1,pageSize:20,pageSizes:[20,50,100,500],start:0,limit:20,filterValue:"",sort:{sortDirection:"asc",sortBy:l.headerItems.length?l.headerItems[0].field:""}},{filterValue:i.q});var h=a.register(o);h&&(l.loadingInitialState=!0,h.then((function(t){e.extend(l,t,{filterValue:i.q})}),n.error).finally((function(){l.loadingInitialState=!1,l.fetch()}))),this.showConfigColumn=l.showConfigColumn=l.configurationOptions&&l.configurationOptions.length,l.$on("$destroy",(function(){a.unregister(o)})),l.fetch(),l.canRedirectHTTPS=u.canRedirectHTTPS(),l.$watch("items",l.fetch),l.toggleSelectAll=function(){for(var e=u.getCurrentDomains(),t=0;t<e.length;t++)l.canRedirectHTTPS?e[t].nonHTTPS&&!e[t].isHttpsRedirecting||(e[t].selected=l.selectAll):e[t].isHttpsRedirecting&&(e[t].selected=l.selectAll)},l.hasSelected=function(){for(var e=u.getCurrentDomains(),t=0;t<e.length;t++)if(e[t].selected)return!0;return!1},l.applyMultiSecureRedirects=function(e){var i,r,n=u.getCurrentDomains();e?(i=t.maketext("Force [asis,HTTPS] Redirect is enabled for the selected domains."),r=t.maketext("The system failed to enable Force [asis,HTTPS] Redirect.")):(i=t.maketext("Force [asis,HTTPS] Redirect is disabled for the selected domains."),r=t.maketext("The system failed to disable Force [asis,HTTPS] Redirect.")),l.hasSelected()&&u.toggleHTTPSRedirect(e).then((function(t){if(t.status){for(var a=0;a<n.length;a++)if(n[a].selected){n[a].selected=!1,n[a].isHttpsRedirecting=e;var s=document.getElementById(n[a].domain+"_domain_link");if(void 0!==s){var o=n[a].isHttpsRedirecting?"https":"http";s.href=o+"://"+n[a].domain}}l.selectAll=!1,l.toggleSelectAll(),f.add({message:i,type:"success",autoClose:1e4})}else f.add({message:r,type:"danger"})}))}}]}}])}));