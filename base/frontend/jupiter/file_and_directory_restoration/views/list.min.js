define(["angular","lodash","cjt/util/table","cjt/util/locale","cjt/util/parse","cjt/decorators/paginationDecorator","cjt/directives/actionButtonDirective","cjt/validator/datatype-validators","app/filters/fileSizeFilter","app/services/backupAPI","cjt/services/alertService","cjt/directives/alert","cjt/directives/alertList","cjt/services/cpanel/componentSettingSaverService"],(function(t,e,r,n,a){"use strict";var o=t.module("App");return o.value("PAGE",PAGE),o.controller("listController",["$scope","$anchorScroll","PAGE","backupAPIService","alertService","componentSettingSaverService",function(t,o,i,c,s,u){var p=new r;p.setSort("name","asc");var l=new r;function d(e,r,n){p.items=[],p.filteredList=[],p.last_id=0,c.listDirectoryContents(e,r,n).then((function(e){!function(e,r){p.load(e),function(e){var r=[],n=1;for(;n<=e.total_pages;)n.toString(),r.push(n),parseInt(n,10),n++;t.goToPages=r}(r),function(e){t.directoryContentsMeta.pageNumber=1,p.update(),t.directoryContentsMeta.maxPages=parseInt(e.total_pages,10),t.directoryContentsMeta.totalItems=parseInt(e.total_records,10),t.directoryContentsMeta.start=parseInt(e.current_record,10),t.directoryContentsMeta.pageNumber=e.current_page,t.directoryContentsMeta.start+t.directoryContentsMeta.pageSize>t.directoryContentsMeta.totalItems?t.directoryContentsMeta.limit=t.directoryContentsMeta.totalItems:t.directoryContentsMeta.limit=t.directoryContentsMeta.start+t.directoryContentsMeta.pageSize-1;t.directoryContents=p.getList(),t.directoryContentsPaginationMessage=p.paginationMessage()}(r)}(function(e){var r=[];return e.forEach((function(e){e.backupPath&&e.parentDir||("/"===t.currentDirectory?(e.backupPath="/"+e.name,e.parentDir="/"):(e.backupPath=t.currentDirectory+e.name,e.parentDir=t.currentDirectory)),r.push(e)})),t.parentDirectory=t.currentDirectory,r}(e.data),e.meta.paginate)})).catch((function(e){t.noMetadataMessage=e})).finally((function(){t.actions.loadingUI=!1,t.actions.loadingData=!1,0===t.directoryContents.length?t.emptyDirectory=!0:t.emptyDirectory=!1}))}function g(e){var r=e.split("/");t.breadCrumb=r.slice(1,r.length-1)}function y(e,r,n){return t.clearBackupList(),c.listBackups(e,r).then((function(e){r&&(t.doesContentExist=a.parsePerlBoolean(e[0].exists)),o("viewContent"),t.isContentTypeDirectory="Directory"===e[0].type,t.isBackupSelected=!0,l.load(e),l.update(),t.backupsMeta=l.getMetadata(),t.backupList=l.getList(),t.backupsPaginationMessage=l.paginationMessage()})).catch((function(e){t.getBackupsError=e})).finally((function(){r||(t.doesContentExist=n),t.selectedContent=e,t.actions.loadingBackups=!1}))}function f(e){u.get(e).then((function(r){r?(t.directoryContentsMeta.pageSize=r.pageSize,d(t.currentDirectory,t.directoryContentsMeta.pageNumber,t.directoryContentsMeta.pageSize)):function(t){u.register(t).then((function(e){C(t)})).catch((function(t){s.add({type:"danger",message:t,group:"backup-restoration",closeable:!0})}))}(e)})).catch((function(t){s.add({type:"danger",message:t,group:"backup-restoration",closeable:!0})}))}function C(e){u.set(e,{pageSize:t.directoryContentsMeta.pageSize}).then((function(e){d(t.currentDirectory,t.directoryContentsMeta.pageNumber,t.directoryContentsMeta.pageSize)})).catch((function(t){s.add({type:"danger",message:t,group:"backup-restortion",closeable:!0})}))}l.setSort("backupDate,backupType,lastModifiedTime,fileSize","desc"),t.setDirectoryContentsPage=function(e){t.clearBackupList(),t.actions.loadingData=!0,e?C("pagination"):d(t.currentDirectory,t.directoryContentsMeta.pageNumber,t.directoryContentsMeta.pageSize)},t.navigateBreadcrumb=function(e){t.clearBackupList(),t.actions.loadingData=!0;for(var r="/",n=0,a=t.breadCrumb.length;n<a;n++){if(e===t.breadCrumb[n]){r=r+t.breadCrumb[n]+"/";break}r=r+t.breadCrumb[n]+"/"}t.currentDirectory=r;d(t.currentDirectory,1,t.directoryContentsMeta.pageSize),g(t.currentDirectory)},t.goToDirectory=function(e){t.actions.loadingData=!0,"/"===e&&(t.breadcrumb=""),t.clearBackupList(),t.currentDirectory!==e&&(t.directoryContentsMeta.pageNumber=1),t.currentDirectory=e;var r=t.currentDirectory.length;"/"!==t.currentDirectory.charAt(r-1)&&(t.currentDirectory=t.currentDirectory+"/"),d(t.currentDirectory,t.directoryContentsMeta.pageNumber,t.directoryContentsMeta.pageSize),g(t.currentDirectory)},t.toggleSelectedBackup=function(e){e===t.backupSelected?t.backupSelected="":t.backupSelected=e},t.listBackups=function(e){return t.actions.loadingBackups=!0,y(e.backupPath,0,e.exists)},t.toggleRestoreConfirmation=function(e){e?(t.confirmSelected=e.backupDate,t.isConfirmingRestoration=!0):(t.confirmSelected="",t.isConfirmingRestoration=!1)},t.restoreSelectedBackup=function(r){return function(r){return t.actions.restoring=!0,c.restoreBackup(r.path,r.backupID).then((function(a){s.add({type:"success",message:n.maketext("The system successfully restored the “[_1]” backup file from the date “[_2]”.",e.escape(r.path),e.escape(r.backupDate)),autoClose:1e4,group:"backup-restoration"}),t.clearBackupList(),t.goToDirectory(t.currentDirectory)})).catch((function(t){s.add({type:"danger",message:t,closeable:!0,group:"backup-restoration"})})).finally((function(){t.actions.restoring=!1,t.toggleRestoreConfirmation()}))}(r)},t.goToParentDirectory=function(){t.actions.loadingData=!0,t.currentDirectory=function(){for(var e="/",r=0,n=t.breadCrumb.length-1;r<n;r++)e=e+t.breadCrumb[r]+"/";return e}();d(t.currentDirectory,1,t.directoryContentsMeta.pageSize),g(t.currentDirectory)},t.findByPathInput=function(e){return e=function(t){0!==t.indexOf("/")&&(t="/"+t);return t}(e),t.getBackupsError="",t.selectedContent=e,y(e,1)},t.goToPage=function(e,r){var n=function(e){return!(e*t.directoryContentsMeta.page_size>t.directoryContentsMeta.total_records)}(e);null===e||isNaN(e)||(n?d(r,e,t.directoryContentsMeta.pageSize):t.pageDoesNotExist=!0)},t.sortDirectoryContentsTable=function(){var e=t.directoryContentsMeta.totalItems;if(t.directoryContentsMeta.pageNumber>=2){var r=t.directoryContentsMeta.pageNumber;p.meta.pageNumber=1,p.update(),p.meta.pageNumber=r}else p.update();t.directoryContentsMeta.totalItems=e,t.directoryContents=p.getList()},t.sortBackupsTable=function(){l.update(),t.backupList=l.getList(),t.backupsPaginationMessage=l.paginationMessage()},t.clearBackupList=function(){t.isConfirmingRestoration=!1,t.getBackupsError="",t.isBackupSelected=!1,t.selectedContent=""},t.checkForEmptyInput=function(e){t.isPathInputEmpty=""===e},t.getBackupsPanelClass=function(t){var e="panel panel-default";return t&&(e+=" restorationPanel"),e},t.getDirContentsPanelClass=function(t){var e="panel panel-default";return t&&(e+=" restorationPanel"),e},t.scrollToBackupList=function(){o("viewContent")},t.userHomeDirDisplay=i.homeDir+"/",t.navigateMethod="input",t.dirContentsPanelOpen=!0,t.backupsPanelOpen=!0,t.currentDirectory="/",t.homeDir="/",t.noMetadataMessage="",t.isPathInputEmpty=!0,t.directoryContentsMeta=p.getMetadata(),t.backupsMeta=l.getMetadata(),t.doesContentExistInfo=n.maketext("When you restore a backup, the system will overwrite existing files and restore deleted files."),t.findByPathInfo=n.maketext("Enter the exact path to the file or directory that you wish to restore."),t.actions={loadingUI:!0,loadingData:!1,loadingBackups:!1},f("pagination")}])}));