define(["angular","lodash","cjt/util/locale","cjt/util/parse","uiBootstrap","cjt/validator/email-validator","app/services/emailAccountsService","app/validators/emailAccountFullLength","cjt/directives/statsDirective","cjt/directives/passwordFieldDirective","cjt/services/alertService","cjt/directives/alert","cjt/directives/alertList","cjt/directives/actionButtonDirective","cjt/directives/toggleLabelInfoDirective","cjt/directives/labelSuffixDirective","cjt/directives/validationContainerDirective","cjt/directives/validationItemDirective","cjt/directives/bytesInput","cjt/services/cpanel/componentSettingSaverService"],(function(e,t,a,i){"use strict";var n;try{n=e.module("cpanel.emailAccounts")}catch(t){n=e.module("cpanel.emailAccounts",[])}return n.value("PAGE",PAGE),n.controller("CreateController",["$scope","$location","$anchorScroll","$timeout","emailAccountsService","PAGE","alertService","$routeParams","componentSettingSaverService","$q",function(n,s,o,l,c,r,u,d,m,p){var g,f=this,v="EmailAccountsCreate",S=decodeURIComponent(d.domain),h="EmailAccountsCreateStayOnPage";function w(){n.showOptionalSettings=!1,n.OptionalSettingsButtonText=a.maketext("Edit Settings"),n.OptionalSettingsIconClass="fas fa-pencil-alt"}function A(e){return m.get(v).then((function(t){if(void 0!==t&&t&&(n.showAllHelp=t.showAllHelp),n.accountStats.available){var a={userName:null,domain:null};return e?a.domain=f.details.domain:n.mailDomains.length>0&&(void 0!==S&&S&&-1!==n.mailDomains.indexOf(S)?a.domain=S:a.domain=r.primaryDomain),a.quota=n.defaultQuota,a.password=null,a.quotaType=r.defaultQuotaSelected,a.sendWelcomeEmail=!0,a.setPassword=!0,a.recoveryEmail=null,a.autoCreateSubaddressFolders=!0,a.assignMaxDiskspace=!1,a.quotaUnit="MB",a.stayOnView=i.parseBoolean(c.getStoredValue(h)),a}g=l((function(){s.path("/list")}),1e4)}))}function C(){var e=f.details.domain||"example.com",a=f.details.userName||"user";f.examplePlusAddress=t.escape(a+"+plusaddress@"+e)}o.yOffset=70,f.isRTL=r.isRTL,f.isLoading=!0,f.statsCssClass="hide-stats",f.details={},n.showAllHelp=!1,n.upgradeURL=c.getUpgradeUrl(),n.requiredPasswordStrength=r.requiredPasswordStrength,n.isInviteSubEnabled=!!r.isInviteSubEnabled,n.defaultQuota=r.userDefinedQuotaDefaultValue?r.userDefinedQuotaDefaultValue:void 0,n.maxQuota=r.maxEmailQuota,n.canSetUnlimited=r.canSetUnlimited,n.maxQuotaHelpText=a.maketext("Quotas cannot exceed [format_bytes,_1].",1024*r.maxEmailQuota*1024),n.maxEmailQuotaText=r.canSetUnlimited?a.maketext("Unlimited"):a.maketext("[format_bytes,_1]",1024*r.maxEmailQuota*1024),n.mailDomains=[],w(),f.toggleOptionalSettingsButtonState=function(){n.showOptionalSettings=!n.showOptionalSettings,!1===n.showOptionalSettings?(f.details.quota=n.defaultQuota,f.details.quotaType=r.defaultQuotaSelected,f.details.sendWelcomeEmail=!0,f.details.autoCreateSubaddressFolders=!0,f.details.assignMaxDiskspace=!1,f.details.quotaUnit="MB",w()):(n.OptionalSettingsButtonText=a.maketext("Reset Settings"),n.OptionalSettingsIconClass="fas fa-trash")},p.all([m.register(v),c.getMailDomains(),c.getEmailStats()]).then((function(e){return n.mailDomains=e[1],n.accountStats=e[2],f.statsCssClass="animate-stats",A().then((function(e){f.details=e}))}),(function(e){u.add({type:"danger",message:e,closeable:!0,replace:!1,group:"emailAccounts"})})).finally((function(){f.isLoading=!1})),f.saveToComponentSettings=function(){return m.set(v,{showAllHelp:n.showAllHelp})},f.stayOnPageChanged=function(){f.details.stayOnView?localStorage.setItem(h,r.securityToken+":true"):localStorage.removeItem(h)},f.scrollToMissingDomains=function(){o("missingDomainSection");var t=e.element(document.querySelector("#missingDomainSection"));t.addClass("section-highlight"),l((function(){t.removeClass("section-highlight")}),11e3)},f.create=function(e){if(f.frmCreateEmail.$submitted=!0,f.frmCreateEmail.$valid&&!f.frmCreateEmail.$pending)return void 0!==e&&e?("unlimited"===e.quotaType&&(n.canSetUnlimited?e.quota=0:e.quota=n.maxQuota),c.createEmail(e).then((function(t){return u.add({type:"success",message:a.maketext("You created “[_1]” ([output,url,_2,View]).",e.userName+"@"+e.domain,"#/list/"+e.userName+"@"+e.domain),closeable:!0,replace:!1,autoClose:1e4,group:"emailAccounts"}),c.getEmailStats().then((function(e){if(n.accountStats=e,f.details.stayOnView)return A(!0).then((function(e){f.details=e,f.frmCreateEmail.$setPristine()}));f.backToListView()}))}),(function(e){u.add({type:"danger",message:e,closeable:!0,replace:!1,group:"emailAccounts"})}))):void 0},f.backToListView=function(){s.path("/list")},f.toggleHelp=function(){n.showAllHelp=!n.showAllHelp,f.saveToComponentSettings(),n.$broadcast("showHideAllChange",n.showAllHelp)},n.$on("$destroy",(function(){localStorage.removeItem(h),m.unregister(v),l.cancel(g)})),n.$watch("emailAccount.details.domain",C),n.$watch("emailAccount.details.userName",C)}])}));