define(["angular","lodash","cjt/util/locale","cjt/util/parse","uiBootstrap","app/services/emailAccountsService","app/filters/encodeURIComponent","cjt/services/alertService","cjt/directives/alert","cjt/directives/alertList","cjt/directives/actionButtonDirective","cjt/directives/toggleSwitchDirective","cjt/directives/toggleLabelInfoDirective","cjt/directives/validationContainerDirective","cjt/directives/validationItemDirective","cjt/services/cpanel/componentSettingSaverService"],(function(e,t,a,n){"use strict";var s=e.module("cpanel.emailAccounts");return s.value("PAGE",PAGE),s.controller("ManageController",["$scope","$location","$anchorScroll","$timeout","emailAccountsService","PAGE","alertService","$routeParams","componentSettingSaverService",function(s,o,i,l,u,c,r,d,p){var g=this;g.isLoading=!0,g.isRTL=c.isRTL,i.yOffset=70;var m="EmailAccountsManageStayOnPage";s.showAllHelp=!1;var f="EmailAccountsManage";p.register(f),g.dprefix=c.dprefix,g.webmailEnabled=n.parseBoolean(c.webmailEnabled),g.requiredPasswordStrength=c.requiredPasswordStrength,g.externalAuthConfig=c.externalAuthModulesConfigured,g.showCalAndContacts=c.showCalendarAndContactItems,g.emailDiskUsageEnabled=c.emailDiskUsageEnabled,g.emailFiltersEnabled=c.emailFiltersEnabled,g.autoResponderEnabled=c.autoResponderEnabled,s.defaultQuota=c.userDefinedQuotaDefaultValue?c.userDefinedQuotaDefaultValue:void 0,s.maxQuota=c.maxEmailQuota,s.canSetUnlimited=c.canSetUnlimited,s.maxQuotaHelpText=a.maketext("Quotas cannot exceed [format_bytes,_1].",1024*c.maxEmailQuota*1024),s.maxEmailQuotaText=c.canSetUnlimited?a.maketext("Unlimited"):a.maketext("[format_bytes,_1]",1024*c.maxEmailQuota*1024),g.stayOnView=n.parseBoolean(u.getStoredValue(m)),s.showAllHelp=!1;var h=decodeURIComponent(d.emailAccount);g.examplePlusAddress=t.escape(h.split("@").join("+plusaddress@"));var v=d.scrollTo,S={};function A(){return l((function(){if(void 0!==v&&v){i(v);var t=e.element(document.querySelector("#"+v));return t.addClass("restriction-section-highlight"),l((function(){t.removeClass("restriction-section-highlight")}),11e3)}}),1e3)}function b(){return p.get(f).then((function(e){void 0!==e&&e&&(s.showAllHelp=e.showAllHelp)})),u.getEmailAccountDetails(h).then((function(t){return S=e.copy(t),g.details=t,g.details.autoCreateSubaddressFolders=n.parseBoolean(g.details.autoCreateSubaddressFolders),g.suspendOptions.login=g.currentSuspendedState.login=t.suspended_login,g.suspendOptions.incoming=g.currentSuspendedState.incoming=t.suspended_incoming,g.suspendOptions.suspended_outgoing=t.suspended_outgoing,g.suspendOptions.hold_outgoing=t.hold_outgoing,g.suspendOptions.has_suspended=t.has_suspended,g.suspendOptions.outgoing=g.currentSuspendedState.outgoing=!0===g.suspendOptions.suspended_outgoing?"suspend":!0===g.suspendOptions.hold_outgoing?"hold":"allow","hold"===g.suspendOptions.outgoing?u.getHeldMessageCount(h).then((function(e){return g.suspendOptions.currentlyHeld=e,g.isLoading=!1,A()}),(function(e){r.add({type:"danger",message:e,closeable:!0,replace:!1,group:"emailAccounts"}),g.isLoading=!1})):(g.isLoading=!1,A())}),(function(e){r.add({type:"danger",message:e,closeable:!0,replace:!1,group:"emailAccounts"}),g.isLoading=!1,g.backToListView()}))}g.currentSuspendedState={},g.suspendOptions={},g.saveToComponentSettings=function(){p.set(f,{showAllHelp:s.showAllHelp})},g.stayOnPageChanged=function(){g.stayOnView?localStorage.setItem(m,c.securityToken+":true"):localStorage.removeItem(m)},g.toggleHelp=function(){s.showAllHelp=!s.showAllHelp,g.saveToComponentSettings(),s.$broadcast("showHideAllChange",s.showAllHelp)},g.currentlyHeldMessageText=function(e){return a.maketext("Delete [quant,_1,message,messages] from the mail queue.",e)},g.update=function(e){if(g.frmManageAccount.$submitted=!0,g.frmManageAccount.$valid&&!g.frmManageAccount.$pending)return"unlimited"!==e.quotaType||s.canSetUnlimited?"unlimited"===e.quotaType&&(e.quota=0):e.quota=s.maxQuota,u.updateEmail(S,e,g.currentSuspendedState,g.suspendOptions).then((function(n){var s=0,o=[];t.forEach(n,(function(e){"danger"===e.type?r.add({type:e.type,message:e.message,closeable:!0,replace:!1,autoClose:e.autoClose,group:"emailAccounts"}):"success"===e.type&&(o.push(e),s+=1)})),s&&(s>1?r.add({type:"success",message:a.maketext("All of your changes to “[_1]” are saved.",e.email),closeable:!0,replace:!1,autoClose:1e4,group:"emailAccounts"}):r.add({type:"success",message:o[0].message,closeable:!0,replace:!1,autoClose:1e4,group:"emailAccounts"}),g.stayOnView?(g.isLoading=!0,g.frmManageAccount.$setPristine(),S={},g.currentSuspendedState={},g.suspendOptions={},g.details={},b()):g.backToListView())}),(function(e){r.add({type:"danger",message:e.message,closeable:!0,replace:!1,group:"emailAccounts"})}))},g.delete=function(e){return u.deleteEmail(e).then((function(){r.add({type:"success",message:a.maketext("You deleted “[_1]”.",e),closeable:!0,replace:!1,autoClose:1e4,group:"emailAccounts"}),g.backToListView()}),(function(e){r.add({type:"danger",message:e,closeable:!0,replace:!1,group:"emailAccounts"})}))},g.backToListView=function(){o.path("/list")},s.$on("$destroy",(function(){p.unregister(f),localStorage.removeItem(m)})),b()}])}));