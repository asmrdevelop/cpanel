define(["angular","lodash","cjt/util/locale","cjt/util/table","cjt/util/parse","cjt/directives/actionButtonDirective","cjt/decorators/paginationDecorator","cjt/directives/toggleSortDirective","cjt/directives/searchDirective","cjt/directives/pageSizeDirective","cjt/directives/alertList","cjt/services/alertService","cjt/services/viewNavigationApi","cjt/directives/quickFiltersDirective","app/services/sseAPIService","uiBootstrap"],(function(e,n,t,s,a){"use strict";var i=e.module("cpanel.applicationManager");return i.value("PAGE",PAGE),i.controller("ManageApplicationsController",["$scope","$routeParams","viewNavigationApi","$uibModal","Apps","defaultInfo","alertService","sseAPIService","PAGE","$timeout",function(e,i,r,o,c,u,p,l,f,d){var m=this;m.is_loading=!1,m.applications=[],m.loading_error=!1,m.loading_error_message="",m.user_home_dir=u.homedir,m.change_in_progress=!1,m.ensureDepList=[],m.secTokenPrefix=f.securityToken,m.sseObj=null;var g=["task_processing","task_complete","task_failed"],_={json:!0},v=new s;function y(e){return e&&(e.ensureDeps={},e.ensureState="",e.ensureInProgress=!1,e.showEnsureView=!1),e}v.setSearchFunction((function(e,n){return-1!==e.name.indexOf(n)})),v.setFilterOptionFunction((function(e,n){return e.type===n})),m.meta=v.getMetadata(),m.filteredList=v.getList(),m.paginationMessage=v.paginationMessage,m.render=function(){m.filteredList=v.update()},m.sortList=function(){m.render()},m.selectPage=function(){m.render()},m.selectPageSize=function(){m.render()},m.searchList=function(){m.render()},m.quota_warning=function(){return t.maketext("You can’t have more than [numf,_1] applications on your account.",c.get_maximum_number_of_apps())},m.show_quota_warning=function(){return c.exceeds_quota()},m.dependenciesExist=function(e){var t=!1;if(e){var s=e.deps;t=n.some(s,(function(e){if(e)return!0}))}return t},m.ensureDependencies=function(e){var t=n.keys(e.deps);n.each(t,(function(n){if(e.deps[n])return c.ensureDependencies(n,e.path).then((function(t){var s=t.data.sse_url,a=!0;e.ensureInProgress=a,e.showEnsureView=a,e.ensureDeps&&(e.ensureDeps[n]={taskId:t.data.task_id,inProgress:a}),m.sseURL||m.sseObj||(m.sseURL=m.secTokenPrefix+s,l.initialize()),m.ensureDepList.push(e)})).catch((function(e){p.add({type:"danger",message:e,closeable:!0,replace:!1,group:"passenger"})}))}))},m.clearEnsureDepsTaskParams=function(e){y(e)},m.getAppLevelEnsureStateMessage=function(e){var n="";switch(e.ensureState){case"processing":n=t.maketext("Ensuring dependencies for your application …");break;case"complete":n=t.maketext("The system ensured the dependencies for your application.");break;case"failure":n=t.maketext("The system couldn’t ensure dependencies for your application. For more information, see the instructions below.");break;default:n=t.maketext("The system queued your application to ensure its dependencies …")}return n},m.getIconClassForEnsureState=function(e){var n="";switch(e){case"complete":n="far fa-check-circle text-success";break;case"failure":n="fas fa-exclamation-circle text-danger";break;default:n="fas fa-spinner fa-spin"}return n};var h=function(e){var t="",s=n.find(m.ensureDepList,(function(s){if(n.keys(s.ensureDeps).length>0)return n.some(s.ensureDeps,(function(n,s){if(n.taskId===e)return t=s,!0}))}));return{ensureType:t,applicationItem:s}};e.$on("sse:task_processing",(function(t,s){var a=s.task_id,i=h(a);if(i.applicationItem){var r=n.indexOf(m.filteredList,i.applicationItem);-1!==r&&(i.applicationItem.ensureDeps[i.ensureType].ensureState="processing",i.applicationItem.ensureInProgress=!0,i.applicationItem.ensureState="processing",n.extend(m.filteredList[r],i.applicationItem),e.$apply(m.render))}}));var I=function(){m.sseObj&&(l.close(m.sseObj),m.sseObj=null,m.sseURL="")},k=function(t,s){var a=n.indexOf(m.filteredList,t.applicationItem);if(-1!==a){t.applicationItem.ensureDeps[t.ensureType].ensureState=s,t.applicationItem.ensureDeps[t.ensureType].inProgress=!1;var i=function(e){return e.ensureInProgress,!!n.findKey(e.ensureDeps,(function(e){return e.inProgress}))}(t.applicationItem);t.applicationItem.ensureInProgress=i,i||(t.applicationItem.ensureState=function(e){e.ensureState;var t=n.findKey(e.ensureDeps,(function(e){return"complete"!==e.ensureState}));return t?e.ensureDeps[t].ensureState:"complete"}(t.applicationItem)),"failure"===s&&(t.applicationItem.ensureDeps[t.ensureType].command=t.applicationItem.deps[t.ensureType]),n.extend(m.filteredList[a],t.applicationItem),e.$apply(m.render)}t.applicationItem.ensureInProgress||"complete"!==t.applicationItem.ensureState&&"failure"!==t.applicationItem.ensureState||(n.remove(m.ensureDepList,t.applicationItem),"complete"===t.applicationItem.ensureState&&d((function(){n.extend(m.filteredList[a],y(t.applicationItem)),e.$apply(m.render)}),5e3)),0===m.ensureDepList.length&&I()};function b(e,s){var a=this;a.confirm_msg=t.maketext("Are you sure that you want to unregister your application (“[_1]”)?",s),a.cancel=function(){e.dismiss("cancel")},a.confirm=function(){return c.remove_application(s).then((function(){v.setSort("name","asc"),n.remove(m.applications,(function(e){return e.name===s})),m.render(),p.add({type:"success",message:t.maketext("You successfully unregistered your application."),closeable:!0,replace:!1,autoClose:1e4,group:"passenger"})})).catch((function(e){p.add({type:"danger",message:e,closeable:!0,replace:!1,group:"passenger"})})).finally((function(){e.close()}))}}function D(e){return i.hasOwnProperty("forceLoad")&&1===i.forceLoad?e=!0:void 0===e&&(e=!1),m.is_loading=!0,c.fetch(e).then((function(e){m.applications=e,m.applications&&(m.applications=n.map(m.applications,(function(e){return e=y(e)}))),v.setSort("name","asc"),v.load(m.applications),m.render()})).catch((function(e){m.loading_error=!0,m.loading_error_message=e})).finally((function(){m.is_loading=!1}))}e.$on("sse:task_complete",(function(e,n){var t=n.task_id,s=h(t);if(s.applicationItem){if("failure"===s.applicationItem.ensureDeps[s.ensureType].ensureState)return;k(s,"complete"),I()}})),e.$on("sse:task_failed",(function(e,n){var t=n.task_id,s=h(t);s.applicationItem&&(k(s,"failure"),I())})),e.$on("sse:ready",(function(e){m.sseObj=l.connect(m.sseURL,g,_)})),e.$on("$destroy",(function(){I()})),m.configure_details=function(e){void 0===e?r.loadView("/details"):r.loadView("/details/"+e.name)},m.toggle_status=function(e){return m.change_in_progress=!0,c.toggle_application_status(e).then((function(n){n.enabled?p.add({type:"success",message:t.maketext("You successfully enabled your application."),closeable:!0,replace:!1,autoClose:1e4,group:"passenger"}):p.add({type:"success",message:t.maketext("You successfully disabled your application."),closeable:!0,replace:!1,autoClose:1e4,group:"passenger"}),e.enabled=a.parsePerlBoolean(n.enabled)})).catch((function(e){p.add({type:"danger",message:e,closeable:!0,replace:!1,group:"passenger"})})).finally((function(){m.change_in_progress=!1}))},b.$inject=["$uibModalInstance","appl_name"],m.confirm_delete_record=function(e){m.change_in_progress=!0,o.open({templateUrl:"confirm_delete.html",controller:b,controllerAs:"ctrl",resolve:{appl_name:function(){return e}}}).result.finally((function(){m.change_in_progress=!1}))},m.refresh=function(){return D(!0)},m.init=function(){p.clear(void 0,"passenger"),D()},m.init()}])}));