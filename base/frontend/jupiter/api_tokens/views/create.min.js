define(["angular","lodash","cjt/util/locale","app/services/apiTokens","cjt/directives/copyField","cjt/directives/timePicker","cjt/directives/datePicker","app/validators/uniqueTokenName","cjt/modules","cjt/directives/actionButtonDirective","cjt/services/cpanel/componentSettingSaverService","cjt/directives/validationContainerDirective","cjt/directives/validationItemDirective","cjt/directives/toggleSwitchDirective","cjt/directives/searchDirective","cjt/directives/indeterminateState","cjt/services/alertService"],(function(e,t,i,r,n,s,a){"use strict";var o="createAPITokenView",c=i.maketext("Create API Token"),u="cpanel.apiTokens.views.create",l=["cjt2.directives.validationContainer","cjt2.directives.validationItem","cjt2.directives.toggleSwitch","cjt2.directives.search","cjt2.directives.indeterminateState",s.namespace,a.namespace,n.namespace],d=["$scope","$location","alertService",r.serviceName,"componentSettingSaverService","CAN_CREATE_LIMITED","apiTokens","features"],p="CreateTokenController",k=function(t,r,n,s,a,u,l,d){t.canCreateLimited=u,t.pageTitle=c,t.RTL=i.is_rtl(),t.showAllHelp=!1,t.selectedFeatures=[],t.ui={stayAfterCopy:!1},t.checkAll={all:!1},t.features=d,t.apiTokens=l,t.working={},t.datePickerOptions={},t.timePickerOptions={};var p=new Date;p.setHours(0),p.setMinutes(0),p.setSeconds(0,0);var k=new Date(p.getTime());k.setHours(23),k.setMinutes(59),k.setSeconds(59,999),k.setFullYear(k.getFullYear()+1),t.init=function(){a.register(o).then((function(e){e&&(t.showAllHelp=e.showAllHelp,t.ui.stayAfterCopy=e.stayAfterCopy)})),t.reset()},t.reset=function(e){t.datePickerOptions.minDate=p,t.timePickerOptions.min=p,t.working={name:"",unrestricted:!u,features:{},tokenExpires:!1,expiresAt:k},t.generatedToken=null,t.pageTitle=c,t.selectedFeatures=[],e&&e.$setPristine()},t._updateCSSS=function(){a.set(o,{showAllHelp:t.showAllHelp,stayAfterCopy:t.ui.stayAfterCopy})},t.toggleHelp=function(){t.showAllHelp=!t.showAllHelp,t._updateCSSS()},t._tokenCreated=function(e){var r;return t.generatedToken=e,t.pageTitle=i.maketext("Token Created Successfully"),t.apiTokens=s.getTokens(),r=t.working.unrestricted?i.maketext("You successfully created an [output,strong,unrestricted] [asis,API] token “[_1]”.",t.working.name):i.maketext("You successfully created a [output,strong,limited-access] [asis,API] token “[_1]”.",t.working.name),n.success(r),e},t.create=function(e){e.tokenExpires&&(e.expiresAt.setHours(23),e.expiresAt.setMinutes(59),e.expiresAt.setSeconds(59,999));var i=e.tokenExpires?Math.floor(e.expiresAt/1e3):null;return s.createToken(e.name,e.unrestricted,t.selectedFeatures,i).then(t._tokenCreated)},t.newTokenExpiresMessage=function(e){var t=i.datetime(e.expiresAt,"datetime_format_medium");return i.maketext("This [asis,API] token will expire on [_1][comment,Bareword is a date].",t)},t.toggleSelectAllFeatures=function(){t.selectedFeatures.length<t.features.length?t.features.forEach((function(e){t.working.features[e.id]=!0})):t.features.forEach((function(e){t.working.features[e.id]=!1})),t.updateSelectedFeatures()},t.getFeaturesIndeterminateState=function(){return t.selectedFeatures.length&&t.features.length&&t.features.length!==t.selectedFeatures.length},t.updateSelectedFeatures=function(){t.selectedFeatures=[],e.forEach(t.working.features,(function(e,i){e&&t.selectedFeatures.push(i)}))},t.backToListView=function(){r.path("/")},t.tokenCopied=function(e){t.ui.stayAfterCopy?t.reset(e):t.backToListView()},t.stayAfterCopyChanged=function(){t._updateCSSS()},t.dateValidator=function(e){t.working.tokenExpires&&t.working.expiresAt&&(t.working.expiresAt.setHours(23),t.working.expiresAt.setMinutes(59),t.working.expiresAt.setSeconds(59,999)),t.working.tokenExpires&&t.datePickerOptions.minDate>t.working.expiresAt&&(e.$invalid=!0,e.$valid=!1)},t.resetDate=function(){t.working.tokenExpires&&(t.working.expiresAt=k)},t.$on("$destroy",a.unregister.bind(a,o)),t.init()};e.module(u,l).controller(p,d.concat(k));var f={apiTokens:[r.serviceName,function(e){return e.fetchTokens()}],features:[r.serviceName,function(e){return e.getFeatures()}]};return{id:"createAPIToken",route:"/create",controller:p,class:k,templateUrl:"views/create.ptt",title:c,namespace:u,showResourcePanel:!0,resolve:f}}));