define(["angular","lodash","cjt/core","app/directives/tableShowing","app/decorators/paginationDecorator","ngSanitize","ngRoute","cjt/modules","cjt/directives/pageSizeButtonDirective","cjt/services/cpanel/componentSettingSaverService","cjt/directives/toggleSortDirective","cjt/directives/searchDirective","cjt/directives/pageSizeDirective","cjt/directives/indeterminateState","cjt/filters/startFromFilter","cjt/decorators/paginationDecorator"],(function(e,t,i,r,n){"use strict";var l=[r.namespace,n.namespace,"ngRoute","ngSanitize","cjt2.filters.startFrom"],a="cpanel.apiTokens.itemLister.directive",c="apiTokensItemLister",s=["$routeParams","$scope","$filter","$log","$window","componentSettingSaverService","ITEM_LISTER_CONSTANTS"],o=function(i,r,n,l,a,s,o){r.viewCallbacks=[],r.checkAll={indeterminate:!1,all:!1};var d={filter:n("filter"),orderBy:n("orderBy"),startFrom:n("startFrom"),limitTo:n("limitTo")};r._filter=function(e){return""!==r.filterValue?d.filter(e,r.filterValue,!1):e},r._sort=function(e){return""!==r.sort.sortDirection&&""!==r.sort.sortBy?d.orderBy(e,r.sort.sortBy,"asc"!==r.sort.sortDirection):e},r._paginate=function(e){if(r.totalItems>t.min(r.pageSizes)){var i=(r.currentPage-1)*r.pageSize,n=r.pageSize;e=d.startFrom(e,i),e=d.limitTo(e,n),r.showPager=!0,r.start=i+1,r.limit=i+e.length}else r.showPager=!1,0===e.length?r.start=0:r.start=1,r.limit=e.length;return e},r._updatedListerState=function(e){if(!r.loadingInitialState){var t={pageSize:r.pageSize,sort:{sortDirection:r.sort.sortDirection,sortBy:r.sort.sortBy}};s.set(c,t)}},r._itemInteracted=function(e,t){t.interactionID&&r._updatedListerState(t.interactionID)},this.registerViewCallback=function(e){r.viewCallbacks.push(e),e(r.filteredItems)},this.getHeaderItems=function(){return r.headerItems},this.deregisterViewCallback=function(e){for(var t=r.viewCallbacks.length-1;t>=0;t--)r.viewCallbacks[t]===e&&r.viewCallbacks.splice(t,1)},r.fetch=function(){var t=[];return r.items&&(t=r._filter(r.items)),r.totalItems=t.length,t=r._sort(t),t=r._paginate(t),r.filteredItems=t,r._updatedListerState(),e.forEach(r.viewCallbacks,(function(e){e(r.filteredItems)})),r.$emit(o.ITEM_LISTER_UPDATED_EVENT,{meta:{filterValue:r.filterValue},items:t}),r._updateSelectAllState(),t},r.focusSearch=function(){e.element(document).find("#"+r.parentID+"_search_input").focus(),a.scrollTop=0},r.tableConfigurationClicked=function(e){r.$emit(o.TABLE_ITEM_BUTTON_EVENT,{actionType:"tableConfigurationClicked",config:e})},r._updateSelectAllState=function(){r.selectedItems=r.filteredItems.filter((function(e){return e.selected})),r.selectedItems.length&&r.filteredItems.length&&r.selectedItems.length===r.filteredItems.length?r.checkAll.all=!0:r.checkAll.all=!1},r.getIndeterminateState=function(){return r.selectedItems.length&&r.filteredItems.length&&r.filteredItems.length!==r.selectedItems.length},r.toggleSelectAll=function(){r.selectedItems.length<r.filteredItems.length?(r.filteredItems.forEach((function(e){e.selected=!0})),r.$emit(o.ITEM_LISTER_SELECT_ALL,{items:r.filteredItems})):(r.filteredItems.forEach((function(e){e.selected=!1})),r.$emit(o.ITEM_LISTER_DESELECT_ALL,{items:r.filteredItems})),r._updateSelectAllState()},r.$on(o.TABLE_ITEM_BUTTON_EVENT,r._itemInteracted),r.$on(o.TABLE_ITEM_SELECTED,r._updateSelectAllState),r.$on(o.TABLE_ITEM_DESELECTED,r._updateSelectAllState),e.extend(r,{maxPages:5,totalItems:r.items.length,filteredItems:[],currentPage:1,pageSize:20,pageSizes:[20,100,500],start:0,limit:20,filterValue:"",sort:{sortDirection:"asc",sortBy:r.headerItems.length?r.headerItems[0].field:""}},{filterValue:i.q}),r._savedStateLoaded=function(t){e.extend(r,t,{filterValue:i.q})};var u=s.register(c);u&&(r.loadingInitialState=!0,u.then(r._savedStateLoaded,l.error).finally((function(){r.loadingInitialState=!1,r.fetch()}))),r.$on("$destroy",(function(){s.unregister(c)})),r.fetch(),r.$watch("items",r.fetch)},d="directives/itemLister.ptt",u=i.config.debug?i.buildFullPath("api_tokens/directives/itemLister.ptt"):d,f=function(i,r,n){t.isUndefined(n.canSelectAll)||"0"===n.canSelectAll||(i.canSelectAll=!0),i.controlsBlock=null,i.contentBlock=null,i._attachControls=function(e){i.controlsBlock.append(e)},i._attachOthers=function(e){e.setAttribute("id",i.parentID+"_transcludePoint"),e.setAttribute("ng-if","filteredItems.length"),i.contentBlock.replaceWith(e)},i._attachTransclude=function(t){e.element(t).hasClass("lister-controls")?i._attachControls(t):i._attachOthers(t)},i._findTranscludes=function(){i.controlsBlock=r.find("#"+i.parentID+"_transcludedControls"),i.contentBlock=r.find("#"+i.parentID+"_transcludePoint");var t=r.find("div.transcluded"),n=t.children();e.forEach(n,i._attachTransclude,i),t.remove()},setTimeout(i._findTranscludes,2)};return e.module(a,l).directive("itemLister",["$window","$log","componentSettingSaverService"].concat((function(e,t,i){return{templateUrl:u,restrict:"EA",scope:{parentID:"@id",items:"=",headerItems:"=",tableConfigurations:"=",createRoute:"@"},transclude:!0,replace:!0,link:f,controller:s.concat(o)}}))),{class:o,namespace:a,link:f,template:d}}));