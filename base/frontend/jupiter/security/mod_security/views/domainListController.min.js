define(["angular","lodash","cjt/util/locale","uiBootstrap","cjt/directives/alertList","cjt/services/alertService","cjt/decorators/paginationDecorator","cjt/directives/toggleSortDirective","cjt/directives/validationItemDirective","cjt/directives/spinnerDirective","cjt/directives/autoFocus","cjt/filters/wrapFilter","cjt/filters/breakFilter","app/services/modSecurityDomainService"],(function(e,t,a){var i=e.module("App"),n=function(e,t){for(var a=0,i=e.length;a<i;a++){var n=s(t,e[a].domain);n?(e[a].enabled=n.enabled,n.exception?e[a].exception=n.exception:delete e[a].exception):e[a].exception&&delete e[a].exception}},s=function(e,t){for(var a=0,i=e.length;a<i;a++)if(e[a].domain===t)return e[a]},o=function(e,t){return function(e,t){for(var a=0,i=e.length;a<i;++a)if(t(e[a]))return a;return-1}(e,(function(e){return t===e.domain}))},l=function(e,t){if(e&&e.length>0){var a=o(e,t);-1!==a&&e.splice(a,1)}},r=function(e,t,a){var i=o(e,t),n={domain:t,exception:a};-1!==i?e.splice(i,1,n):e.push(n)};return i.controller("domainListController",["$scope","$routeParams","$q","modSecurityDomainService","spinnerAPI","alertService",function(s,o,c,d,u,m){s.clearFilter=function(){return s.meta.filterValue="",s.activeSearch=!1,s.filteredData=!1,s.selectedRow=-1,s.fetch()},s.startFilter=function(){s.activeSearch=!0,s.filteredData=!1,s.selectedRow=-1;var e=c.defer();e.promise.then((function(){s.selectPage(1)})).then((function(){s.filteredData=!0})),e.resolve()},s.toggleRow=function(e,t){e.preventDefault(),t===s.selectedRow?s.selectedRow=-1:s.selectedRow=t},s.selectPage=function(t){return s.selectedRow=-1,t&&e.isNumber(t)&&(s.meta.pageNumber=t),s.fetch()},s.sortList=function(e,t){s.selectedRow=-1,t||s.fetch()},s.triggerToggleSearch=function(e){27===e.keyCode&&s.toggleSearch(!0),13===e.keyCode&&s.toggleSearch()},s.toggleSearch=function(e){var t=s.meta.filterValue;t||!s.activeSearch&&!s.filteredData?e&&s.activeSearch?s.clearFilter():t&&s.startFilter():s.clearFilter()},s.fetch=function(){return u.start("loadingSpinner"),d.fetchList(s.meta).then((function(a){var i,n;s.domainList=(i=a.items,(n=s.issues)&&0!==n.length?(e.forEach(i,(function(e){var a=t.find(n,(function(t){return e.domain===t.domain}));!function(e,t){t&&(t.exception?e.exception=t.exception:e.exception&&delete e.exception)}(e,a)})),i):i),s.totalItems=a.totalItems,s.totalPages=a.totalPages,s.totalEnabled=a.totalEnabled,s.totalDisabled=a.totalDisabled}),(function(e){m.add({type:"danger",message:e,id:"fetchError"})})).then((function(){u.stop("loadingSpinner")}))},s.setDomain=function(t){return u.start("loadingSpinner"),t.enabled?d.enableDomains(t.domain).then((function(e){s.totalEnabled++,s.totalDisabled--,l(s.issues,t.domain),t.exception&&delete t.exception,f(),m.add({type:"success",message:a.maketext("Successfully enabled [asis,ModSecurity™] on “[_1]”.",e.items[0].domain),id:"enableSuccess"})}),(function(a){var i;if(e.isString(a))i=a;else{var n=a.items[0].exception,o=a.items[0].enabled;r(s.issues,t.domain,n),t.exception=n,t.enabled=o,f(),i=a.error}m.add({type:"danger",message:i,id:"enableFailure"})})).then((function(){u.stop("loadingSpinner")})):d.disableDomains(t.domain).then((function(e){s.totalDisabled++,s.totalEnabled--,l(s.issues,t.domain),t.exception&&delete t.exception,f(),m.add({type:"success",message:a.maketext("Successfully disabled [asis,ModSecurity™] on “[_1]”.",e.items[0].domain),id:"disableSuccess"})}),(function(a){var i;if(e.isString(a))i=a;else{var n=a.items[0].exception,o=a.items[0].enabled;r(s.issues,t.domain,n),t.exception=n,t.enabled=o,f(),i=a.error}m.add({type:"danger",message:i,id:"disableFailed"})})).then((function(){u.stop("loadingSpinner")}))},s.enableAllDomains=function(t){return t.preventDefault(),u.start("loadingSpinner"),d.enableAllDomains().then((function(e){p(),n(s.domainList,e.items),s.totalItems=e.totalItems,s.totalPages=e.totalPages,s.totalEnabled=e.totalItems,s.totalDisabled=0,m.add({type:"success",message:a.maketext("Successfully enabled [asis,ModSecurity™] on all domains."),id:"enableAllSuccess"})}),(function(t){var a;e.isString(t)?a=t:(n(s.domainList,t.items),s.issues=t.items||[],f(),s.totalEnabled=t.totalEnabled,s.totalDisabled=t.totalDisabled,a=t.error),m.add({type:"danger",message:a,id:"enableAllFailed"})})).then((function(){u.stop("loadingSpinner")}))},s.disableAllDomains=function(t){return t.preventDefault(),u.start("loadingSpinner"),d.disableAllDomains().then((function(e){n(s.domainList,e.items),s.issues=e.items||[],s.totalItems=e.totalItems,s.totalPages=e.totalPages,s.totalDisabled=e.totalItems,s.totalEnabled=0,m.add({type:"success",message:a.maketext("Successfully disabled [asis,ModSecurity™] on all domains."),id:"disableAllSuccess"})}),(function(t){var a;e.isString(t)?a=t:(n(s.domainList,t.items),s.issues=t.items||[],f(),s.totalEnabled=t.totalEnabled,s.totalDisabled=t.totalDisabled,a=t.error),m.add({type:"danger",message:a,id:"disableAllFailed"})})).finally((function(){u.stop("loadingSpinner"),s.openConfirmation=null}))};var f=function(){var e=t.find(s.domainList,(function(e){return!!e.exception}));s.hasIssues=void 0!==e};s.hasIssue=function(e){return!!e.exception};var p=function(){delete s.hasIssues};s.hasDisabledDomains=function(){return s.totalDisabled>0},s.confirm=function(e){s.openConfirmation=e||null};s.activeSearch=!1,s.filteredData=!1,s.totalEnabled=0,s.totalDisabled=0,s.selectedRow=-1,s.alerts=m.getAlerts(),s.hasIssues=!1,s.issues=[],s.openConfirmation=null,s.isInstalled=PAGE.installed,s.hasFeature=PAGE.hasFeature,s.hasFeature&&(s.domainList=[],s.totalPages=0,s.totalItems=0,s.meta={filterBy:o.filterBy||"*",filterCompare:o.filterCompare||"contains",filterValue:o.filterValue||"",pageSize:o.pageSize||10,pageNumber:o.pageNumber||1,sortDirection:o.sortDirection||"asc",sortBy:o.sortBy||"domain",sortType:o.sortType,pageSizes:[10,20,50,100]}),s.$watch("meta.filterValue",(function(e,t){e!==t&&(s.activeSearch=!1)})),s.$watch("meta.pageSize",(function(e,t){e!==t&&s.selectPage(1)})),function(){if(i.firstLoad.domainList&&PAGE.domainList){i.firstLoad.domainList=!1;var e=d.prepareList(PAGE.domainList);s.meta.pageNumber=1,s.domainList=e.items,s.totalItems=e.totalItems,s.totalPages=e.totalPages,s.totalEnabled=PAGE.domainList.meta.modsec.total_enabled,s.totalDisabled=PAGE.domainList.meta.modsec.total_disabled}else s.selectPage(1)}()}])}));