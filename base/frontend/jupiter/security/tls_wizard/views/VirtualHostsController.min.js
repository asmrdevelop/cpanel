define(["angular","cjt/util/locale","jquery","cjt/modules","ngSanitize","app/services/CertificatesService","app/services/IdVerDefaults","cjt/filters/qaSafeIDFilter","cjt/directives/cpanel/searchSettingsPanel","cjt/directives/triStateCheckbox","cjt/directives/spinnerDirective","cjt/decorators/growlDecorator","app/services/CountriesService","app/services/LocationService"],(function(t,e,r){"use strict";t.module("App").controller("VirtualHostsController",["$rootScope","$scope","$controller","$location","$filter","$timeout","$sce","$routeParams","$window","CertificatesService","IdVerDefaults","spinnerAPI","growl","CountriesService","LocationService","SearchSettingsModel","alertService",function(i,n,o,a,c,s,_,d,l,u,f,g,p,v,m,h,w){n.show_introduction_block=u.show_introduction_block,n.domains=u.get_all_domains(),n.virtual_hosts=u.get_virtual_hosts(),n.pending_certificates=u.get_pending_certificates(),n.showExistingCertificates=!1,n.working_virtual_host=null,n.LOCALE=e,n.resolution_timeout=0,n.cart_items=[],n.filterValue=null,n.checkout_mode=!1,n.filteredProducts=[],n.showAdvancedSettings=!0,i.addToCartGrowl=null,n.COUNTRIES=v;var y={};n.identity_verification=y;for(var k=u.get_stored_extra_settings().advanced_identity_verification,C=0;C<n.virtual_hosts.length;C++){var b=n.virtual_hosts[C].get_display_name();y[b]={},k&&k[b]?f.restore_previous(y[b],k[b]):f.set_defaults(y[b])}t.forEach(n.virtual_hosts,(function(t){t.reset(),t.show_wildcards=!1})),n.domains=u.get_all_domains(),n.domains=c("filter")(n.domains,{is_wildcard:!1}),n.virtual_hosts=u.get_virtual_hosts(),n.virtual_hosts=c("filter")(n.virtual_hosts,(function(t){return!t.display_name.match(/^\*\./)})),n.searchFilterOptions=new h(u.get_product_search_options(),{certTerms:{"1_year":!0,"2_year":!1,"3_year":!1}}),n.filter_products=function(){var t=u.get_products();t=n.searchFilterOptions.filter(t),n.filteredProducts=t},n.slow_scroll_to_top=function(){r("body,html").animate({scrollTop:0},2e3)},n.go_to_product_filters=function(){n.showAdvancedSettings=!0,n.slow_scroll_to_top()};var x=["domains","providers","cert-info"],S=c("qaSafeID");n.get_cart_certs_title=function(){return e.maketext("[quant,_1,Certificate,Certificates]",n.get_cart_items().length)},n.get_vhost_showing_text=function(){var t=c("filter")(n.get_virtual_hosts(),n.filterValue);return e.maketext("[output,strong,Showing] [numf,_1] of [quant,_2,website,websites]",t.length,n.get_virtual_hosts().length)},n.get_domains_showing_text=function(t){var r=1+t.display_meta.start,i=t.display_meta.limit,n=t.get_domain_count(!0);return e.maketext("[output,strong,Showing] [numf,_1] - [numf,_2] of [quant,_3,domain,domains].",r,i,n)},n.deselect_unresolved_msg=function(t){var r=t.get_selected_domains().filter((function(t){return 0===t.resolved})).length;return e.maketext("Deselect all unresolved domains ([numf,_1]).",r)},n.go_to_pending=function(t){t?a.path("/pending-certificates/").search("orderItemID",t):a.path("/pending-certificates")},n.pending_certificate=function(e){var r=!1;return t.forEach(n.pending_certificates,(function(i){t.forEach(i.vhost_names,(function(t){t===e.display_name&&(r=i.order_item_id)}))})),r},n.get_certpanel_class=function(t){return n.pending_certificate(t)?"panel-default":"panel-primary"},n.view_pending_certificate=function(t){var e=n.pending_certificate(t);n.go_to_pending(e)},n.get_currency_string=function(t,r){t+=.001;var i=e.numf(t);return i="$"+i.substring(0,i.length-1),r&&(i+=" "+r),i},n.get_virtual_hosts=function(){var t=n.virtual_hosts;return n.filterValue&&(t=c("filter")(t,n.filterValue)),n.checkout_mode&&(t=c("filter")(t,{added_to_cart:!0})),t},n.get_virtual_host_classes=function(t){return{"col-lg-4":n.virtual_hosts.length>2,"col-lg-6":n.virtual_hosts.length<=2,"panel-success":t.is_ssl}},n.get_step_panel_classes=function(t,e){var r=["col-sm-12","col-xs-12"];return n.working_virtual_host===t.display_name?(r.push("col-md-4"),r.push("col-lg-4")):(r.push("col-md-12"),r.push("col-lg-12")),e&&r.push("cert-step-panel-current"),r},n.get_cart_price=function(){var e=0;return t.forEach(n.get_cart_items(),(function(t){e+=t.get_price()})),e},n.get_cart_items=function(){return n.cart_items=c("filter")(n.virtual_hosts,{added_to_cart:!0}),n.cart_items},n.checkout=function(){n.checkout_mode=!0},n.get_product_form_fields=function(){return[]},n.get_step=function(t){return t.get_step()},n.go_step=function(t,e){if(n.can_step(t,e))return t.go_step(e)},n.focus_virtual_host=function(){},n.check_selected_domains=function(t){(n.resolution_timeout&&s.cancel(n.resolution_timeout),t&&t.added_to_cart)&&(c("filter")(t.get_selected_domains(),(function(t){if(1!==t.resolved)return!0})).length&&(w.add({type:"danger",message:e.maketext("You have altered an item in your cart. The system has removed that item. After you make the necessary changes, add that item back to your cart."),group:"tlsWizard"}),n.remove_from_cart(t)));n.resolution_timeout=s((function(t){n.ensure_dns(t)}),850,!0,u.get_all_selected_domains())},n.deselect_domains=function(e){t.forEach(e,(function(t){t.selected=!1}))},n.get_current_or_default_provider=function(){return u.get_default_provider_name()},n.ensure_dns=function(e){if(!(e=c("filter")(e,{selected:!0,resolved:-1})).length)return!1;t.forEach(e,(function(t){t.resolving=!0,g.start(n.get_spinner_id(t.domain))}));var r=n.get_current_or_default_provider();return u.ensure_domains_can_pass_dcv(e,r).finally((function(){var r;t.forEach(e,(function(t){if(0===t.resolved&&t.selected){var e=u.get_virtual_host_by_display_name(t.vhost_name),i=n.virtual_hosts[e];if(i&&"providers"===i.get_step()){n.go_step(i,"domains");var o=l.document.getElementById(n.get_domain_id(t));o&&!r&&(r=o,s((function(){r.focus()})))}}g.stop(n.get_spinner_id(t.domain))}))}))},n.get_domain_id=function(t){return S(t.vhost_name+"_"+t.domain)},n.check_product_match=function(t,e){return!(!t||!e)&&(t.id===e.id&&t.provider===e.provider||void 0)},n.can_step=function(t,e){if(e===x[0])return!0;if(e===x[1])return!!t.get_selected_domains().length;if(e===x[2]){var r=t.get_product();if(!r)return!1;if(!(r=u.get_product_by_id(r.provider,r.id)))return!1;if(!n.get_product_form_fields(r))return!1}return!1},n.get_product_by_id=function(t,e){return u.get_product_by_id(t,e)},n.can_next_step=function(e){var r,i=e.get_step();return t.forEach(x,(function(t,e){t===i&&(r=x[e+1])})),n.can_step(e,r)},n.next_step=function(e){var r,i=e.get_step();t.forEach(x,(function(t,e){t===i&&(r=x[e+1])})),n.can_step(e,r)&&(n.focus_virtual_host(e),e.go_step(r))},n.get_spinner_id=function(t){return S("dns_resolving_"+t)},n.get_products=function(t){return n.filteredProducts},n.set_product=function(t,e){t.set_product_price(e.price),t.set_product(e)},n.all_domains_resolved=function(t){var e=t.get_selected_domains();return 0!==(e=c("filter")(e,(function(t){return 1===t.resolved}))).length},n.can_add_to_cart=function(t){var e=t.get_product();return!!e&&!!(e=u.get_product_by_id(e.provider,e.id))},n.add_to_cart=function(t){if(!n.can_add_to_cart(t)||!n.all_domains_resolved(t))return!1;t.added_to_cart=!0,t.go_step("added-to-cart"),t.set_identity_verification(n.identity_verification[t.display_name]),n.working_virtual_host=null,i.addToCartGrowl&&(i.addToCartGrowl.ttl=0,i.addToCartGrowl=null);var r={ttl:-1,variables:{buttonLabel:e.maketext("Proceed to checkout."),showAction:!0,action:function(){n.purchase()}}};i.addToCartGrowl=p.success(e.maketext("Item Successfully Added to Cart."),r)},n.get_domain_certificate=function(t){return u.get_domain_certificate(t)},n.view_existing_certificate=function(){},n.get_virtual_host_certificate=function(t){return u.get_virtual_host_certificate(t)},n.build_csr_url=function(t){var e=n.get_virtual_host_certificate(t);if(e&&e.certificate){var r="";return r+="../../ssl/install.html?id=",r+=encodeURIComponent(e.certificate.id)}},n.get_existing_certificate_name=function(t){var r,i=n.get_virtual_host_certificate(t);if(i&&i.certificate){var o=i.certificate;"dv"===o.validation_type?r=e.maketext("A [output,abbr,DV,Domain Validated] certificate is installed."):"ov"===o.validation_type?r=e.maketext("An [output,abbr,OV,Organization Validated] certificate is installed."):"ev"===o.validation_type?r=e.maketext("An [output,abbr,EV,Extended Validation] certificate is installed."):o.is_self_signed&&(r=e.maketext("A self-signed certificate is installed."))}return r||(r=e.maketext("A certificate of unknown type is installed.")),r},n.get_domain_lock_classes=function(t){var e=n.get_virtual_host_certificate(t);if(e&&e.certificate)return e.certificate.is_self_signed?"grey-padlock":"green-padlock"},n.remove_from_cart=function(t){i.addToCartGrowl&&(i.addToCartGrowl.ttl=0,i.addToCartGrowl.destroy(),i.addToCartGrowl=null),t.added_to_cart=!1},n.go_to_simple=function(){u.hard_reset(),m.go_to_simple_create_route().search("")},n.purchase=function(){i.addToCartGrowl&&(i.addToCartGrowl.ttl=0,i.addToCartGrowl.destroy(),i.addToCartGrowl=null),u.save({advanced_identity_verification:y})?a.path("/purchase"):w.add({type:"danger",message:e.maketext("Failed to save information to browser cache."),group:"tlsWizard"})},d.domain&&(t.forEach(c("filter")(n.domains,{domain:d.domain},!0),(function(t){t.selected=!0,n.check_selected_domains(t.vhost_name)})),n.virtual_hosts=u.get_virtual_hosts(),n.filterValue=d.domain)}])}));