define(["angular","cjt/util/locale","uiBootstrap","cjt/filters/wrapFilter","cjt/directives/actionButtonDirective","cjt/directives/jsonFieldDirective","cjt/decorators/growlDecorator","app/services/publishService"],(function(e,t){"use strict";var a=e.module("App"),i=a.controller("publishController",["$scope","$routeParams","publishService","$timeout","alertService","growl","$q",function(i,s,n,r,l,o,m){i.domainList=[],i.templateList=[],i.meta={filterBy:"*",filterCompare:"contains",filterValue:"",maxPages:0,totalItems:i.domainList.length,currentPage:1,pageSize:10,pageSizes:[10,20,50,100],start:0,limit:10};var p=function(){for(var e=0,t=i.templateList.length;e<t;e++)delete i.templateList[e].selected},c=function(){for(var e=0,t=i.domainList.length;e<t;e++)delete i.domainList[e].selected};i.resetSteps=function(){i.status={isDomainSelectOpen:!0,isDomainSelectStep:!0,isTemplateSelectOpen:!1,isTemplateSelectStep:!1,isTemplateFormOpen:!1,isTemplateFormStep:!1,isPublished:!1},i.selectedDomain=null,c(),i.selectedTemplate=null,p()},i.getPanelClass=function(e){var t="panel-default",a="panel-primary";return("domain"===e&&i.status.isDomainSelectStep||"template"===e&&i.status.isTemplateSelectStep||"publish"===e&&i.status.isTemplateFormStep)&&(t=a),t};var u=function(e){var t=e.data;i.meta.totalItems=e.meta.paginate.total_records,i.meta.records_before_filter=e.meta.records_before_filter;var a=t;if(i.meta.totalItems>_.min(i.meta.pageSizes)){var s=(i.meta.currentPage-1)*i.meta.pageSize;i.showPager=!0,i.meta.start=s+1,i.meta.limit=s+a.length}else i.showPager=!1,0===a.length?i.meta.start=0:i.meta.start=1,i.meta.limit=a.length;if(i.selectedDomain)for(var n=0,r=a.length;n<r;n++)if(a[n].domain===i.selectedDomain.domain){a[n].selected=!0;break}i.domainList=a,1===i.meta.records_before_filter&&i.selectDomain(0)},d=function(){return n.listDomains(i.meta).then((function(e){u(e)}),(function(e){o.error(e)}))};i.clearFilter=function(){return i.meta.filterValue="",i.selectPage(1)},i.selectPage=function(t){return t&&e.isNumber(t)&&(i.meta.currentPage=t),d()},i.getSiteAddress=function(e){return"//"+e.domain},i.getFileManagerLink=function(e){if(e){var t=e.documentroot.slice(e.homedir.length+1);return i.deprefix+i.fileManagerObj.url+"?dir="+encodeURIComponent(t)}return i.fileManagerObj.url},i.selectDomain=function(e){if(i.selectedDomain=i.domainList[e],c(),i.domainList[e].selected=!0,i.status.isDomainSelectOpen=i.status.isDomainSelectStep=!1,i.status.isTemplateSelectOpen=i.status.isTemplateSelectStep=!0,i.status.isTemplateFormOpen=i.status.isTemplateFormStep=!1,p(),i.selectedDomain.template_settings.hasOwnProperty("template"))for(var t=0,a=i.templateList.length;t<a;t++){var s=i.templateList[t];if(i.selectedDomain.template_settings.template===s.template){s.selected=!0;break}}i.selectedTemplate=!1,i.status.isPublished=!1,1===i.templateList.length&&i.selectTemplate(0)},i.selectTemplate=function(e){i.selectedTemplate=i.templateList[e],p(),i.templateList[e].selected=!0;for(var t=0,a=i.templateList[e].meta.fields.length;t<a;t++){var s=i.templateList[e].meta.fields[t];i.selectedDomain.template_settings.hasOwnProperty(s.id)&&(s.value=i.selectedDomain.template_settings[s.id])}i.status.isTemplateSelectOpen=i.status.isTemplateSelectStep=!1,i.status.isTemplateFormOpen=i.status.isTemplateFormStep=!0,i.status.isPublished=!1},i.hasError=function(e){var t=document.publish_form;return!(!t.hasOwnProperty(e.name)||"function"!=typeof t[e.name].checkValidity)&&!t[e.name].checkValidity()},i.publishTemplate=function(e,a){window.mixpanel&&window.mixpanel.track("SitePublisher-Publish-Clicked",{template:e.template});var s=document.publish_form.getElementsByClassName("has-error").length;return s?(o.error(t.maketext("The form has returned [quant,_1,error,errors]",s)),m.when(!1)):(a.url=i.getSiteAddress(a),n.publish(e,a).then((function(){i.status.isTemplateFormOpen=i.status.isTemplateFormStep=!1,i.status.isPublished=!0,window.mixpanel&&window.mixpanel.track("SitePublisher-Publish-Success",{template:e.template}),a.template_settings={is_empty:0,path:e.path,template:e.template,docroot:a.documentroot};for(var t=0,s=e.meta.fields.length;t<s;t++){var n=e.meta.fields[t];a.template_settings[n.id]=n.value}}),(function(t){window.mixpanel&&window.mixpanel.track("SitePublisher-Publish-Failed",{template:e.template}),o.error(t)})))};i.locale=t,i.resetSteps(),PAGE.deprefix&&(i.deprefix=PAGE.deprefix),PAGE.fileManagerObj&&(i.fileManagerObj=PAGE.fileManagerObj),PAGE.accountsObj&&(i.accountsObj=PAGE.accountsObj),PAGE.webdiskObj&&(i.webdiskObj=PAGE.webdiskObj),a.firstLoad.publish&&PAGE.domainList&&PAGE.templateList?(a.firstLoad.publish=!1,i.templateList=n.convertResponseToList(PAGE.templateList).data.sort((function(e,t){var a,i,s,n;return e.meta.information.hasOwnProperty("date")?(a=Date.parse(e.meta.information.date),isNaN(a)&&(a=0)):a=0,t.meta.information.hasOwnProperty("date")?(i=Date.parse(t.meta.information.date),isNaN(i)&&(i=0)):i=0,i>a?1:i<a?-1:(s=e.meta.information.hasOwnProperty("name")&&null!==e.meta.information.name?e.meta.information.name.toLowerCase():"")>(n=t.meta.information.hasOwnProperty("name")&&null!==t.meta.information.name?t.meta.information.name.toLowerCase():"")?1:s<n?-1:0})),u(n.convertResponseToList(PAGE.domainList))):d(),s.domain&&(i.meta.filterValue=s.domain,i.selectPage(1).then((function(){i.domainList.forEach((function(e,t){e.domain===s.domain&&i.selectDomain(t)}))})))}]);function s(e){e.decorator("$exceptionHandler",["$injector",function(e){return function(a){e.get("growl").error(t.maketext("A problem has occurred: [_1]",a.message))}}])}return s.$inject=["$provide"],a.config(s),i}));