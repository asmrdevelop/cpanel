define("app/services/publishService",["angular","cjt/io/api","cjt/io/uapi-request","cjt/io/uapi"],(function(e,t,a){var i=e.module("App");function r(i){var r={convertResponseToList:function(t){var a=[];if(t.data){for(var i=t.data,r=0,n=i.length;r<n;r++)a.push(i[r]);var o=t.meta||{};return e.isDefined(o.paginate)||(o.paginate={total_records:i.length,total_pages:1}),e.isDefined(o.records_before_filter)||(o.records_before_filter=i.length),{meta:o,data:a}}return{meta:{paginate:{total_records:0,total_pages:0}},data:[]}},listDomains:function(e){var r=i.defer(),n=new a.Class;return n.initialize("SiteTemplates","list_user_settings"),e&&(e.currentPage&&n.addPaging(e.currentPage,e.pageSize||10),e.filterBy&&e.filterCompare&&e.filterValue&&n.addFilter(e.filterBy,e.filterCompare,e.filterValue)),t.promise(n.getRunArguments()).done((function(e){(e=e.parsedResponse).status?r.resolve(e):r.reject(e.error)})),r.promise},publish:function(e,r){var n=i.defer(),o=new a.Class,s=_.map(e.meta.fields,(function(e){if(e.value&&0===e.type.indexOf("date",0)){if("Invalid Date"===e.value.toString())return{id:e.id,value:""};try{return{id:e.id,value:new Date(e.value).toISOString()}}catch(t){return{id:e.id,value:""}}}return _.pick(e,["id","value"])}));o.initialize("SiteTemplates","publish"),o.addArgument("path",e.path),o.addArgument("template",e.template),o.addArgument("docroot",r.documentroot),o.addArgument("domain_url",r.url);for(var l=0,m=s.length;l<m;l++)o.addArgument(s[l].id,s[l].value);return t.promise(o.getRunArguments()).done((function(e){(e=e.parsedResponse).status?n.resolve(e):n.reject(e.error)})),n.promise}};return r}return r.$inject=["$q"],i.factory("publishService",r)})),define("app/views/publishController",["angular","cjt/util/locale","uiBootstrap","cjt/filters/wrapFilter","cjt/directives/actionButtonDirective","cjt/directives/jsonFieldDirective","cjt/decorators/growlDecorator","app/services/publishService"],(function(e,t){"use strict";var a=e.module("App"),i=a.controller("publishController",["$scope","$routeParams","publishService","$timeout","alertService","growl","$q",function(i,r,n,o,s,l,m){i.domainList=[],i.templateList=[],i.meta={filterBy:"*",filterCompare:"contains",filterValue:"",maxPages:0,totalItems:i.domainList.length,currentPage:1,pageSize:10,pageSizes:[10,20,50,100],start:0,limit:10};var u=function(){for(var e=0,t=i.templateList.length;e<t;e++)delete i.templateList[e].selected},p=function(){for(var e=0,t=i.domainList.length;e<t;e++)delete i.domainList[e].selected};i.resetSteps=function(){i.status={isDomainSelectOpen:!0,isDomainSelectStep:!0,isTemplateSelectOpen:!1,isTemplateSelectStep:!1,isTemplateFormOpen:!1,isTemplateFormStep:!1,isPublished:!1},i.selectedDomain=null,p(),i.selectedTemplate=null,u()},i.getPanelClass=function(e){var t="panel-default",a="panel-primary";return("domain"===e&&i.status.isDomainSelectStep||"template"===e&&i.status.isTemplateSelectStep||"publish"===e&&i.status.isTemplateFormStep)&&(t=a),t};var c=function(e){var t=e.data;i.meta.totalItems=e.meta.paginate.total_records,i.meta.records_before_filter=e.meta.records_before_filter;var a=t;if(i.meta.totalItems>_.min(i.meta.pageSizes)){var r=(i.meta.currentPage-1)*i.meta.pageSize;i.showPager=!0,i.meta.start=r+1,i.meta.limit=r+a.length}else i.showPager=!1,0===a.length?i.meta.start=0:i.meta.start=1,i.meta.limit=a.length;if(i.selectedDomain)for(var n=0,o=a.length;n<o;n++)if(a[n].domain===i.selectedDomain.domain){a[n].selected=!0;break}i.domainList=a,1===i.meta.records_before_filter&&i.selectDomain(0)},d=function(){return n.listDomains(i.meta).then((function(e){c(e)}),(function(e){l.error(e)}))};i.clearFilter=function(){return i.meta.filterValue="",i.selectPage(1)},i.selectPage=function(t){return t&&e.isNumber(t)&&(i.meta.currentPage=t),d()},i.getSiteAddress=function(e){return"//"+e.domain},i.getFileManagerLink=function(e){if(e){var t=e.documentroot.slice(e.homedir.length+1);return i.deprefix+i.fileManagerObj.url+"?dir="+encodeURIComponent(t)}return i.fileManagerObj.url},i.selectDomain=function(e){if(i.selectedDomain=i.domainList[e],p(),i.domainList[e].selected=!0,i.status.isDomainSelectOpen=i.status.isDomainSelectStep=!1,i.status.isTemplateSelectOpen=i.status.isTemplateSelectStep=!0,i.status.isTemplateFormOpen=i.status.isTemplateFormStep=!1,u(),i.selectedDomain.template_settings.hasOwnProperty("template"))for(var t=0,a=i.templateList.length;t<a;t++){var r=i.templateList[t];if(i.selectedDomain.template_settings.template===r.template){r.selected=!0;break}}i.selectedTemplate=!1,i.status.isPublished=!1,1===i.templateList.length&&i.selectTemplate(0)},i.selectTemplate=function(e){i.selectedTemplate=i.templateList[e],u(),i.templateList[e].selected=!0;for(var t=0,a=i.templateList[e].meta.fields.length;t<a;t++){var r=i.templateList[e].meta.fields[t];i.selectedDomain.template_settings.hasOwnProperty(r.id)&&(r.value=i.selectedDomain.template_settings[r.id])}i.status.isTemplateSelectOpen=i.status.isTemplateSelectStep=!1,i.status.isTemplateFormOpen=i.status.isTemplateFormStep=!0,i.status.isPublished=!1},i.hasError=function(e){var t=document.publish_form;return!(!t.hasOwnProperty(e.name)||"function"!=typeof t[e.name].checkValidity)&&!t[e.name].checkValidity()},i.publishTemplate=function(e,a){window.mixpanel&&window.mixpanel.track("SitePublisher-Publish-Clicked",{template:e.template});var r=document.publish_form.getElementsByClassName("has-error").length;return r?(l.error(t.maketext("The form has returned [quant,_1,error,errors]",r)),m.when(!1)):(a.url=i.getSiteAddress(a),n.publish(e,a).then((function(){i.status.isTemplateFormOpen=i.status.isTemplateFormStep=!1,i.status.isPublished=!0,window.mixpanel&&window.mixpanel.track("SitePublisher-Publish-Success",{template:e.template}),a.template_settings={is_empty:0,path:e.path,template:e.template,docroot:a.documentroot};for(var t=0,r=e.meta.fields.length;t<r;t++){var n=e.meta.fields[t];a.template_settings[n.id]=n.value}}),(function(t){window.mixpanel&&window.mixpanel.track("SitePublisher-Publish-Failed",{template:e.template}),l.error(t)})))};i.locale=t,i.resetSteps(),PAGE.deprefix&&(i.deprefix=PAGE.deprefix),PAGE.fileManagerObj&&(i.fileManagerObj=PAGE.fileManagerObj),PAGE.accountsObj&&(i.accountsObj=PAGE.accountsObj),PAGE.webdiskObj&&(i.webdiskObj=PAGE.webdiskObj),a.firstLoad.publish&&PAGE.domainList&&PAGE.templateList?(a.firstLoad.publish=!1,i.templateList=n.convertResponseToList(PAGE.templateList).data.sort((function(e,t){var a,i,r,n;return e.meta.information.hasOwnProperty("date")?(a=Date.parse(e.meta.information.date),isNaN(a)&&(a=0)):a=0,t.meta.information.hasOwnProperty("date")?(i=Date.parse(t.meta.information.date),isNaN(i)&&(i=0)):i=0,i>a?1:i<a?-1:(r=e.meta.information.hasOwnProperty("name")&&null!==e.meta.information.name?e.meta.information.name.toLowerCase():"")>(n=t.meta.information.hasOwnProperty("name")&&null!==t.meta.information.name?t.meta.information.name.toLowerCase():"")?1:r<n?-1:0})),c(n.convertResponseToList(PAGE.domainList))):d(),r.domain&&(i.meta.filterValue=r.domain,i.selectPage(1).then((function(){i.domainList.forEach((function(e,t){e.domain===r.domain&&i.selectDomain(t)}))})))}]);function r(e){e.decorator("$exceptionHandler",["$injector",function(e){return function(a){e.get("growl").error(t.maketext("A problem has occurred: [_1]",a.message))}}])}return r.$inject=["$provide"],a.config(r),i})),define("app/index",["angular","cjt/core","cjt/modules","ngRoute","uiBootstrap"],(function(e,t){return function(){return e.module("App",["ngRoute","ui.bootstrap","angular-growl","cjt2.cpanel"]),require(["cjt/bootstrap","uiBootstrap","cjt/views/applicationController","app/views/publishController"],(function(a){var i=e.module("App");i.firstLoad={publish:!0},i.value("PAGE",CPANEL.PAGE),i.controller("BaseController",["$rootScope","$scope","$route","$location",function(e,t,a,i){t.loading=!1,e.$on("$routeChangeStart",(function(){t.loading=!0})),e.$on("$routeChangeSuccess",(function(){t.loading=!1})),e.$on("$routeChangeError",(function(){t.loading=!1})),t.current_route_matches=function(e){return i.path().match(e)},t.go=function(e){i.path(e)}}]),i.config(["$routeProvider","$locationProvider",function(e,a){e.when("/publish",{controller:"publishController",templateUrl:t.buildFullPath("site_publisher/views/publishView.html.tt"),resolve:{}}),e.otherwise({redirectTo:"/publish"})}]),a("#content","App")}))}}));